<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>De Grazia - Automotores</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.3em;
            color: #333;
            text-align: center;
        }

        .header .user-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .nav-mobile {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 0.85em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .card h3 {
            font-size: 1em;
            color: #333;
            margin-bottom: 8px;
        }

        .card p {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .estado-disponible { color: #28a745; font-weight: bold; }
        .estado-reservado { color: #ffc107; font-weight: bold; }
        .estado-vendido { color: #dc3545; font-weight: bold; }

        .usuario-card.activo { border-left-color: #28a745; }
        .usuario-card.suspendido { border-left-color: #dc3545; }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 1.2em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .config-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #ffc107;
        }

        .config-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .config-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffc107;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Responsive mejorado para m√≥viles */
        @media (max-width: 400px) {
            body {
                padding: 5px;
            }
            
            .section {
                padding: 12px;
            }
            
            .section h2 {
                font-size: 1.1em;
            }
            
            .nav-btn {
                padding: 10px 12px;
                font-size: 0.8em;
            }
            
            .btn {
                padding: 12px;
                font-size: 0.9em;
            }
            
            .card {
                padding: 12px;
            }
            
            .card h3 {
                font-size: 0.9em;
            }
            
            .card p {
                font-size: 0.8em;
            }
            
            .form-group input,
            .form-group select {
                padding: 10px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 1.1em;
            }
            
            /* Tablas responsive */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            /* Formularios de minuta */
            .minuta-form .form-group {
                margin-bottom: 10px;
            }
        }
        
        /* Scroll suave */
        .list-container {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevenir zoom en inputs en iOS */
        input, select, textarea {
            font-size: 16px !important;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display:flex; align-items:center; gap:12px; justify-content:center;">
                    <img id="brandLogo" class="brand-logo" src="/assets/logo.png" alt="De Grazia - Automotores" onerror="this.onerror=null;this.src='/assets/logo.svg'" style="border-radius:50%; width:56px; height:56px;">
                <div>
                    <h1 style="margin:0; font-size:1.2em">De Grazia - Automotores</h1>
                    <div class="user-info" id="userInfo">No conectado</div>
                </div>
            </div>
        </div>

        <nav class="nav-mobile" id="mainNav" style="display: none;">
            <button class="nav-btn" onclick="showSection('dashboard')">üè† Inicio</button>
            <button class="nav-btn" onclick="showSection('vehiculos')">üöó Stock</button>
            <button class="nav-btn" onclick="showSection('clientes')">üë• Clientes</button>
            <button class="nav-btn" onclick="showSection('minutas')">üìã Minutas</button>
            <button class="nav-btn premium-only" onclick="showSection('usuarios')">üë§ Usuarios</button>
            <button class="nav-btn premium-only" onclick="showSection('auditoria')">üîç Auditor√≠a</button>
        </nav>

        <!-- Login -->
        <section id="login" class="section active">
            <h2>üîê Iniciar Sesi√≥n</h2>
            
            <div class="config-box">
                <h4>‚öôÔ∏è Configuraci√≥n del Servidor</h4>
                <input type="text" id="serverIP" placeholder="IP del servidor (ej: 192.168.1.100)" value="concesionaria-app-production.up.railway.app">
                <small style="color: #856404;">Ya configurado para acceso p√∫blico. Solo haz clic en "Iniciar Sesi√≥n"</small>
            </div>

            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="loginEmail" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="Tu contrase√±a">
            </div>
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showSection('register')">Crear Cuenta</button>
        </section>

        <!-- Register -->
        <section id="register" class="section">
            <h2>üìù Crear Cuenta</h2>
            <div class="form-group">
                <label>üë§ Nombre</label>
                <input type="text" id="regNombre" placeholder="Tu nombre">
            </div>
            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="regEmail" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="regPassword" placeholder="Tu contrase√±a">
            </div>
            <div class="form-group">
                <label>üé≠ Rol</label>
                <select id="regRol">
                    <option value="vendedor">Vendedor</option>
                    <option value="administrador">Administrador</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="register()">Registrarse</button>
            <button class="btn btn-secondary" onclick="showSection('login')">Volver al Login</button>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="section">
            <h2>üè† Dashboard</h2>
            <div class="card">
                <h3>üëã Bienvenido</h3>
                <p>Usa el men√∫ superior para navegar por la aplicaci√≥n.</p>
            </div>
            <div class="card">
                <h3>üìä Resumen</h3>
                <p id="dashboardStats">Cargando estad√≠sticas...</p>
            </div>
        </section>

        <!-- Veh√≠culos -->
        <section id="vehiculos" class="section">
            <h2>üöó Stock de Veh√≠culos</h2>
            <div class="list-container" id="vehiculosList">
                <p class="empty-message">Cargando veh√≠culos...</p>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">‚ûï Agregar Veh√≠culo</h3>
            <form onsubmit="agregarVehiculo(event)">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="vehTipo" required>
                        <option value="auto">Auto</option>
                        <option value="camioneta">Camioneta</option>
                        <option value="moto">Moto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" id="vehMarca" required placeholder="Ej: Toyota">
                </div>
                <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" id="vehModelo" required placeholder="Ej: Corolla">
                </div>
                <div class="form-group">
                    <label>Versi√≥n</label>
                    <input type="text" id="vehVersion" placeholder="Ej: XEI">
                </div>
                <div class="form-group">
                    <label>A√±o</label>
                    <input type="number" id="vehAnio" required placeholder="2024">
                </div>
                <div class="form-group">
                    <label>Condici√≥n</label>
                    <select id="vehCondicion" required>
                        <option value="nuevo">Nuevo</option>
                        <option value="usado">Usado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Precio</label>
                    <input type="number" id="vehPrecio" required placeholder="25000000">
                </div>
                <div class="form-group">
                    <label>Dominio</label>
                    <input type="text" id="vehDominio" placeholder="ABC123">
                </div>
                <div class="form-group">
                    <label>Imagen (miniatura)</label>
                    <input type="file" id="vehImagen" accept="image/*">
                </div>
                <button type="submit" class="btn btn-success">Agregar Veh√≠culo</button>
            </form>
        </section>

        <!-- Clientes -->
        <section id="clientes" class="section">
            <h2>üë• Clientes</h2>
            <div class="list-container" id="clientesList">
                <p class="empty-message">Cargando clientes...</p>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">‚ûï Agregar Cliente</h3>
            <form onsubmit="agregarCliente(event)">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="cliNombre" required placeholder="Juan">
                </div>
                <div class="form-group">
                    <label>Apellido</label>
                    <input type="text" id="cliApellido" required placeholder="P√©rez">
                </div>
                <div class="form-group">
                    <label>DNI</label>
                    <input type="text" id="cliDni" required placeholder="12345678">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="cliTelefono" placeholder="1122334455">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="cliEmail" placeholder="cliente@email.com">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <input type="text" id="cliDireccion" placeholder="Calle 123">
                </div>
                <button type="submit" class="btn btn-success">Agregar Cliente</button>
            </form>
        </section>

        <!-- Minutas -->
        <section id="minutas" class="section">
            <h2>üìã Minutas de Venta</h2>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:8px;">
                <div></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="toggleMinutaForm()" style="padding:10px 15px; width:auto;">‚ûï Minuta R√°pida</button>
                    <button class="btn btn-success" onclick="toggleMinutaProfesional()" style="padding:10px 15px; width:auto;">üìÑ Minuta Profesional</button>
                </div>
            </div>

            <!-- Formulario Minuta R√°pida -->
            <div id="minutaForm" style="display:none; margin-bottom:15px; background:#f1f5f9; padding:12px; border-radius:10px;">
                <h4 style="margin:0 0 15px 0; color:#667eea;">Minuta R√°pida</h4>
                <div class="form-group">
                    <label>Veh√≠culo</label>
                    <select id="minVehiculo"></select>
                </div>
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="minCliente"></select>
                </div>
                <div class="form-group">
                    <label>Precio Original</label>
                    <input type="number" id="minPrecioOriginal">
                </div>
                <div class="form-group">
                    <label>Precio Final</label>
                    <input type="number" id="minPrecioFinal">
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <input type="text" id="minObservaciones">
                </div>
                <div class="form-group">
                    <label>Financiamiento</label>
                    <select id="minFinanciamiento">
                        <option value="">Ninguno</option>
                        <option value="financiera">Financiera</option>
                        <option value="concesionaria">Concesionaria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Anticipo (si aplica)</label>
                    <input type="number" id="minFinAnticipo" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Cuotas (si aplica)</label>
                    <input type="number" id="minFinCuotas" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Precio financiado (si aplica)</label>
                    <input type="number" id="minFinPrecio" placeholder="0">
                </div>
                <div class="form-group">
                    <label>¬øTrae veh√≠culo en parte de pago?</label>
                    <input type="checkbox" id="minTradein">
                </div>
                <div class="form-group">
                    <label>Datos del veh√≠culo entregado (marca, modelo, a√±o, valor)</label>
                    <input type="text" id="minTradeinDatos" placeholder="Ej: Toyota Corolla 2015 - valor 1.200.000">
                </div>
                <div class="form-group">
                    <label>Monto de reserva</label>
                    <input type="number" id="minReservaMonto" value="1000000">
                </div>
                <button class="btn btn-success" onclick="submitMinuta()">Confirmar Minuta</button>
                <button class="btn btn-secondary" onclick="toggleMinutaForm()">Cancelar</button>
            </div>

            <!-- Formulario Minuta Profesional Completo -->
            <div id="minutaProfesionalForm" style="display:none; margin-bottom:15px; background:#fff; padding:20px; border-radius:12px; border:2px solid #667eea; box-shadow:0 4px 20px rgba(0,0,0,0.1);">
                <div style="text-align:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #667eea;">
                    <h3 style="margin:0; color:#333; font-size:1.3em;">üìÑ MINUTA DE VENTA DE VEH√çCULO / MOTO</h3>
                    <p style="margin:5px 0 0 0; color:#666; font-size:0.85em;">Documento formal de operaci√≥n comercial</p>
                </div>

                <!-- A. Datos Generales -->
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#667eea; font-size:1em;">üìç A. Datos Generales</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Lugar</label>
                            <input type="text" id="mpLugar" placeholder="Ciudad, Provincia" style="padding:10px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Fecha</label>
                            <input type="date" id="mpFecha" style="padding:10px;">
                        </div>
                    </div>
                </div>

                <!-- B. Datos del Comprador -->
                <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#1976d2; font-size:1em;">üë§ B. Datos del Comprador</h4>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label style="font-size:0.85em;">Nombre / Raz√≥n Social *</label>
                        <input type="text" id="mpCompradorNombre" required placeholder="Nombre completo o raz√≥n social" style="padding:10px;">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">DNI / CUIT *</label>
                            <input type="text" id="mpCompradorDni" required placeholder="12.345.678" style="padding:10px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Tel√©fono</label>
                            <input type="tel" id="mpCompradorTelefono" placeholder="11-2233-4455" style="padding:10px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin:10px 0 0 0;">
                        <label style="font-size:0.85em;">Domicilio</label>
                        <input type="text" id="mpCompradorDomicilio" placeholder="Calle, N√∫mero, Ciudad" style="padding:10px;">
                    </div>
                    <div class="form-group" style="margin:10px 0 0 0;">
                        <label style="font-size:0.85em;">Email</label>
                        <input type="email" id="mpCompradorEmail" placeholder="email@ejemplo.com" style="padding:10px;">
                    </div>
                </div>

                <!-- C. Datos del Vendedor -->
                <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#388e3c; font-size:1em;">üè™ C. Datos del Vendedor</h4>
                    <div class="form-group" style="margin:0;">
                        <label style="font-size:0.85em;">Nombre del Vendedor *</label>
                        <input type="text" id="mpVendedorNombre" required placeholder="Nombre del vendedor" style="padding:10px;">
                    </div>
                </div>

                <!-- D. Datos del Veh√≠culo/Moto -->
                <div style="background:#fff3e0; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#f57c00; font-size:1em;">üöó D. Datos del Veh√≠culo / Moto</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Marca *</label>
                            <input type="text" id="mpVehiculoMarca" required placeholder="Toyota, Honda..." style="padding:10px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Modelo *</label>
                            <input type="text" id="mpVehiculoModelo" required placeholder="Corolla, Civic..." style="padding:10px;">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">A√±o *</label>
                            <input type="number" id="mpVehiculoAnio" required placeholder="2024" style="padding:10px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Dominio (Patente)</label>
                            <input type="text" id="mpVehiculoDominio" placeholder="ABC 123" style="padding:10px;">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">N√∫mero de Motor</label>
                            <input type="text" id="mpVehiculoMotor" placeholder="Nro. Motor" style="padding:10px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">N√∫mero de Chasis</label>
                            <input type="text" id="mpVehiculoChasis" placeholder="Nro. Chasis" style="padding:10px;">
                        </div>
                    </div>
                </div>

                <!-- E. Condiciones de la Operaci√≥n -->
                <div style="background:#fce4ec; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#c2185b; font-size:1em;">üí≥ E. Condiciones de la Operaci√≥n</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondContado" name="mpCondicion"> Contado efectivo
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondReserva" name="mpCondicion" onchange="toggleReservaMonto()"> Reserva
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondAnticipo" name="mpCondicion"> Anticipo + Saldo
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondCredito" name="mpCondicion"> Cr√©dito interno
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondFinanciacion" name="mpCondicion" onchange="toggleFinanciacionCampos()"> Financiaci√≥n
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondTarjeta" name="mpCondicion" onchange="toggleTarjetaCuotas()"> Tarjeta de cr√©dito
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondPermuta" name="mpCondicion" onchange="togglePermutaCampos()"> Permuta
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; padding:8px; background:white; border-radius:6px; cursor:pointer;">
                            <input type="checkbox" id="mpCondOtro" name="mpCondicion" onchange="toggleOtroCampo()"> Otro
                        </label>
                    </div>
                    
                    <!-- Campos condicionales -->
                    <div id="mpReservaMontoBox" style="display:none; margin-top:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Monto de Reserva</label>
                            <input type="number" id="mpReservaMonto" placeholder="Monto reserva" style="padding:10px;">
                        </div>
                    </div>
                    
                    <div id="mpFinanciacionBox" style="display:none; margin-top:10px; background:white; padding:10px; border-radius:6px;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.85em;">Financiera</label>
                                <input type="text" id="mpFinanciera" placeholder="Nombre financiera" style="padding:10px;">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.85em;">Cantidad de Cuotas</label>
                                <input type="number" id="mpFinCuotas" placeholder="12, 24, 36..." style="padding:10px;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="mpTarjetaCuotasBox" style="display:none; margin-top:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Cuotas con Tarjeta</label>
                            <input type="number" id="mpTarjetaCuotas" placeholder="3, 6, 12..." style="padding:10px;">
                        </div>
                    </div>
                    
                    <div id="mpPermutaBox" style="display:none; margin-top:10px; background:white; padding:10px; border-radius:6px;">
                        <div class="form-group" style="margin:0 0 10px 0;">
                            <label style="font-size:0.85em;">Datos del veh√≠culo entregado en permuta</label>
                            <input type="text" id="mpPermutaDatos" placeholder="Marca, Modelo, A√±o, Dominio" style="padding:10px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Valor de tasaci√≥n</label>
                            <input type="number" id="mpPermutaValor" placeholder="Valor en $" style="padding:10px;">
                        </div>
                    </div>
                    
                    <div id="mpOtroBox" style="display:none; margin-top:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:0.85em;">Especificar otra condici√≥n</label>
                            <input type="text" id="mpOtroTexto" placeholder="Describir condici√≥n" style="padding:10px;">
                        </div>
                    </div>
                </div>

                <!-- F. Precio Total de Venta -->
                <div style="background:#e8eaf6; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#3f51b5; font-size:1em;">üí∞ F. Precio Total de Venta</h4>
                    <div class="form-group" style="margin:0;">
                        <label style="font-size:0.85em;">Monto Final *</label>
                        <input type="number" id="mpPrecioFinal" required placeholder="0" style="padding:12px; font-size:1.1em; font-weight:bold;">
                    </div>
                </div>

                <!-- G. Observaciones -->
                <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#616161; font-size:1em;">üìù G. Observaciones</h4>
                    <div class="form-group" style="margin:0;">
                        <textarea id="mpObservaciones" rows="3" placeholder="Observaciones adicionales, acuerdos especiales, etc." style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; resize:vertical;"></textarea>
                    </div>
                </div>

                <!-- Firmas Digitales -->
                <div style="background:#fff9c4; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#f9a825; font-size:1em;">‚úçÔ∏è Firmas Digitales</h4>
                    <p style="font-size:0.8em; color:#666; margin-bottom:10px;">‚ö†Ô∏è Las firmas solo pueden ser editadas por administradores premium</p>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label style="font-size:0.85em; display:block; margin-bottom:5px;">Firma del Vendedor</label>
                            <canvas id="mpFirmaVendedor" style="width:100%; height:100px; border:2px dashed #ccc; border-radius:8px; background:white;" onclick="abrirFirma('vendedor')"></canvas>
                            <button type="button" class="btn btn-secondary firma-btn" style="margin-top:5px; padding:6px 10px; font-size:0.8em; width:100%;" onclick="abrirFirma('vendedor')" id="btnFirmaVendedor" disabled>‚úçÔ∏è Firmar</button>
                        </div>
                        <div>
                            <label style="font-size:0.85em; display:block; margin-bottom:5px;">Firma del Comprador</label>
                            <canvas id="mpFirmaComprador" style="width:100%; height:100px; border:2px dashed #ccc; border-radius:8px; background:white;" onclick="abrirFirma('comprador')"></canvas>
                            <button type="button" class="btn btn-secondary firma-btn" style="margin-top:5px; padding:6px 10px; font-size:0.8em; width:100%;" onclick="abrirFirma('comprador')" id="btnFirmaComprador" disabled>‚úçÔ∏è Firmar</button>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-success" onclick="guardarMinutaProfesional()" style="flex:1; min-width:120px;">üíæ Guardar Minuta</button>
                    <button class="btn btn-primary" onclick="previsualizarMinuta()" style="flex:1; min-width:120px;">üëÅÔ∏è Previsualizar</button>
                    <button class="btn btn-secondary" onclick="toggleMinutaProfesional()" style="flex:1; min-width:120px;">‚ùå Cancelar</button>
                </div>
            </div>

            <!-- Modal de Firma -->
            <div id="firmaModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; padding:20px;">
                <div style="background:white; border-radius:12px; max-width:400px; margin:50px auto; padding:20px;">
                    <h4 style="margin:0 0 15px 0; text-align:center;">‚úçÔ∏è Dibujar Firma</h4>
                    <canvas id="firmaCanvas" width="350" height="150" style="border:2px solid #667eea; border-radius:8px; width:100%; touch-action:none;"></canvas>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn btn-success" onclick="confirmarFirma()" style="flex:1;">‚úÖ Confirmar</button>
                        <button class="btn btn-secondary" onclick="limpiarFirma()" style="flex:1;">üîÑ Limpiar</button>
                        <button class="btn btn-danger" onclick="cerrarFirma()" style="flex:1;">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Modal de Previsualizaci√≥n -->
            <div id="previsualizacionModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; padding:10px; overflow-y:auto;">
                <div style="background:white; border-radius:12px; max-width:600px; margin:20px auto; padding:25px;">
                    <div id="previsualizacionContenido"></div>
                    <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="imprimirMinuta()" style="flex:1; min-width:100px;">üñ®Ô∏è Imprimir</button>
                        <button class="btn btn-success" onclick="exportarPDF()" style="flex:1; min-width:100px;">üìÑ Exportar PDF</button>
                        <button class="btn btn-secondary" onclick="cerrarPrevisualizacion()" style="flex:1; min-width:100px;">‚ùå Cerrar</button>
                    </div>
                </div>
            </div>

            <div class="list-container" id="minutasList">
                <p class="empty-message">Cargando minutas...</p>
            </div>
        </section>

        <!-- Usuarios (Premium) -->
        <section id="usuarios" class="section">
            <h2>üë§ Control de Usuarios</h2>
            
            <!-- Resumen de Actividad en Tiempo Real -->
            <div id="actividadResumen" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:15px; border-radius:10px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px 0;">üìä Resumen de Actividad</h4>
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; font-size:0.85em;">
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.5em; font-weight:bold;" id="totalUsuarios">-</div>
                        <div>Usuarios</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.5em; font-weight:bold;" id="usuariosActivos">-</div>
                        <div>Activos Hoy</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.5em; font-weight:bold;" id="minutasHoy">-</div>
                        <div>Minutas Hoy</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.5em; font-weight:bold;" id="accionesHoy">-</div>
                        <div>Acciones Hoy</div>
                    </div>
                </div>
            </div>
            
            <div style="display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap;">
                <button class="btn btn-primary" style="flex:1; min-width:100px; padding:10px; font-size:0.85em;" onclick="cargarAlertasRecientes()">üîî Alertas</button>
                <button class="btn btn-secondary" style="flex:1; min-width:100px; padding:10px; font-size:0.85em;" onclick="cargarNotificaciones()">üì® Notificaciones</button>
                <button class="btn btn-success" style="flex:1; min-width:100px; padding:10px; font-size:0.85em;" onclick="actualizarResumenActividad()">üîÑ Actualizar</button>
            </div>

            <div id="alertasBox" style="display:none; margin-bottom:12px; background:#fff3cd; padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0;">üîî Alertas Premium</h4>
                    <button onclick="document.getElementById('alertasBox').style.display='none'" style="background:none; border:none; font-size:1.2em; cursor:pointer;">‚úï</button>
                </div>
                <div class="list-container" id="alertasList" style="max-height:200px;"></div>
            </div>

            <div id="notificacionesBox" style="display:none; margin-bottom:12px; background:#d4edda; padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0;">üì® Notificaciones</h4>
                    <button onclick="document.getElementById('notificacionesBox').style.display='none'" style="background:none; border:none; font-size:1.2em; cursor:pointer;">‚úï</button>
                </div>
                <div class="list-container" id="notificacionesList" style="max-height:200px;"></div>
            </div>

            <h4 style="margin:10px 0;">üë• Usuarios Registrados</h4>
            <div class="list-container" id="usuariosList" style="max-height:none;">
                <p class="empty-message">Cargando usuarios...</p>
            </div>
        </section>

        <!-- Auditor√≠a (Premium) -->
        <section id="auditoria" class="section">
            <h2>üîç Auditor√≠a</h2>
            
            <!-- Botones de Exportaci√≥n -->
            <div style="margin-bottom: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0;">üìä Exportar Datos</h4>
                <button class="btn btn-success" onclick="descargarExcel()" style="margin-right: 10px;">
                    üì• Descargar Excel
                </button>
                <button class="btn btn-primary" onclick="descargarJSON()">
                    üìÑ Descargar JSON
                </button>
                <p style="margin: 10px 0 0 0; font-size: 0.8em; color: #666;">
                    Descarga todos los datos para subir a Google Drive
                </p>
            </div>
            
            <div class="list-container">
                <table style="width: 100%; font-size: 0.8em;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 8px;">Fecha</th>
                            <th style="padding: 8px;">Usuario</th>
                            <th style="padding: 8px;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="auditoriaBody">
                        <tr><td colspan="3" class="empty-message">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">üö™</button>
    </div>

    <script>
        // Configuraci√≥n
        let API_URL = 'http://localhost:4000';
        let currentUser = null;
        let currentSessionId = null;

        function getServerURL() {
            // Detectar autom√°ticamente si estamos en producci√≥n o local
            const currentHost = window.location.hostname;
            const currentProtocol = window.location.protocol;
            
            // Si estamos en el mismo servidor (producci√≥n) y NO estamos en un WebView/file://, usar la misma URL
            // En WebView (protocol file:) window.location.hostname suele estar vac√≠o; en ese caso forzamos el serverIP
            if (currentProtocol !== 'file:' && currentHost !== '' && currentHost !== 'localhost' && currentHost !== '127.0.0.1' && !currentHost.startsWith('192.168')) {
                return `${currentProtocol}//${currentHost}`;
            }
            
            // Si hay IP configurada manualmente. Por defecto usar producci√≥n para APK.
            const serverIP = document.getElementById('serverIP').value || localStorage.getItem('serverIP') || 'concesionaria-app-production.up.railway.app';
            localStorage.setItem('serverIP', serverIP);
            
            if (serverIP.includes('ngrok') || serverIP.includes('railway') || serverIP.includes('render')) {
                return `https://${serverIP}`;
            }
            return `http://${serverIP}:4000`;
        }

        // Funciones de navegaci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            if (currentUser && currentSessionId) {
                trackNavegacion(sectionId);
            }

            switch(sectionId) {
                case 'vehiculos': cargarVehiculos(); break;
                case 'clientes': cargarClientes(); break;
                case 'minutas': cargarMinutas(); break;
                case 'usuarios': cargarUsuarios(); break;
                case 'auditoria': cargarAuditoria(); break;
            }
        }

        function showMainMenu(show) {
            document.getElementById('mainNav').style.display = show ? 'flex' : 'none';
            document.getElementById('logoutBtn').style.display = show ? 'block' : 'none';
            
            document.querySelectorAll('.premium-only').forEach(btn => {
                btn.style.display = (show && currentUser && currentUser.es_premium) ? 'inline-block' : 'none';
            });
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            API_URL = getServerURL();
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(`${API_URL}${endpoint}`, options);
            const contentType = (response.headers.get('content-type') || '').toLowerCase();
            const text = await response.text();
            if (contentType.includes('application/json')) {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return { __parseError: true, raw: text, status: response.status, contentType };
                }
            }
            // Non-JSON response ‚Äî return raw text and metadata so caller can show it
            return { __raw: text, status: response.status, contentType };
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('‚ö†Ô∏è Ingresa email y contrase√±a');
                return;
            }

            try {
                API_URL = getServerURL();
                const endpoint = '/api/auth/login';
                console.log('Login -> calling', getServerURL() + endpoint);
                const result = await apiCall(endpoint, 'POST', { email, password });
                
                if (result.user) {
                    currentUser = result.user;
                    currentSessionId = result.user.sesion_id;
                    
                    // Persist current user for app sessions
                    try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch(e){}

                    document.getElementById('userInfo').textContent = `${currentUser.nombre} (${currentUser.rol})`;
                    showMainMenu(true);
                    showSection('dashboard');
                    
                    alert('‚úÖ Bienvenido ' + currentUser.nombre);
                } else if (result && result.__raw) {
                    alert('‚ùå Error al iniciar sesi√≥n: servidor respondi√≥ con HTML/text (status=' + result.status + ', content-type=' + result.contentType + '):\n\n' + (result.__raw || '').slice(0,1000));
                    console.error('Login raw response', result);
                } else if (result && result.__parseError) {
                    alert('‚ùå Error al parsear JSON del servidor (status=' + result.status + '):\n' + (result.raw || ''));
                    console.error('Login parse error', result);
                } else {
                    alert('‚ùå ' + (result.message || 'Error al iniciar sesi√≥n'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n. Verifica la IP del servidor.\n\n' + error.message);
            }
        }

        async function register() {
            const nombre = document.getElementById('regNombre').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const rol = document.getElementById('regRol').value;

            if (!nombre || !email || !password) {
                alert('‚ö†Ô∏è Completa todos los campos');
                return;
            }

            try {
                API_URL = getServerURL();
                const result = await apiCall('/api/auth/register', 'POST', { nombre, email, password, rol });
                
                if (result.user) {
                    alert('‚úÖ Usuario registrado correctamente');
                    showSection('login');
                } else {
                    alert('‚ùå ' + (result.message || 'Error al registrar'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        async function logout() {
            if (currentUser && currentSessionId) {
                try {
                    await apiCall('/api/auth/logout', 'POST', { 
                        usuario_id: currentUser.id, 
                        sesion_id: currentSessionId 
                    });
                } catch (e) {}
            }
            
            currentUser = null;
            currentSessionId = null;
            showMainMenu(false);
            showSection('login');
            document.getElementById('userInfo').textContent = 'No conectado';
        }

        async function trackNavegacion(seccion) {
            try {
                await apiCall('/api/tracking/navegacion', 'POST', {
                    sesion_id: currentSessionId,
                    usuario_id: currentUser.id,
                    seccion,
                    accion: 'visita',
                    detalles: {}
                });
            } catch (e) {}
        }

        // Data loading functions
        async function cargarVehiculos() {
            try {
                const vehiculos = await apiCall('/api/vehiculos');
                const container = document.getElementById('vehiculosList');
                const esAdmin = currentUser && (currentUser.es_premium || currentUser.super_admin || currentUser.rol === 'administrador' || currentUser.rol === 'admin');
                
                container.innerHTML = vehiculos.length ? vehiculos.map(v => `
                    <div class="card" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
                        <div style="width:90px; flex: 0 0 90px; display:flex; align-items:center; justify-content:center;">
                            <img src="${v.imagen || '/assets/logo.png'}" onerror="this.onerror=null;this.src='/assets/logo.svg'" alt="${v.marca} ${v.modelo}" class="circular-thumb" style="width:80px; height:65px; border-radius:8px; object-fit:cover;">
                        </div>
                        <div style="flex:1; min-width:150px;">
                            <h3 style="font-size:0.95em; margin-bottom:4px;">${v.marca} ${v.modelo} ${v.version || ''}</h3>
                            <p style="margin:2px 0;"><strong>A√±o:</strong> ${v.anio} | <strong>Km:</strong> ${v.kilometraje?.toLocaleString() || 'N/A'}</p>
                            <p style="margin:2px 0;"><strong>Precio:</strong> $${v.precio?.toLocaleString() || 'N/A'}</p>
                            <p style="margin:2px 0;"><strong>Estado:</strong> <span class="estado-${v.estado}">${v.estado}</span></p>
                            ${esAdmin ? `
                                <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
                                    <button class="btn btn-secondary" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="editarVehiculoPrompt(${v.id}, '${v.marca}', '${v.modelo}', ${v.precio || 0}, '${v.estado}')">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-danger" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="eliminarVehiculo(${v.id})">üóëÔ∏è</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('') : '<p class="empty-message">No hay veh√≠culos</p>';
            } catch (e) {
                document.getElementById('vehiculosList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarClientes() {
            try {
                const clientes = await apiCall('/api/clientes');
                const container = document.getElementById('clientesList');
                const esAdmin = currentUser && (currentUser.es_premium || currentUser.super_admin || currentUser.rol === 'administrador' || currentUser.rol === 'admin');
                
                container.innerHTML = clientes.length ? clientes.map(c => `
                    <div class="card">
                        <h3 style="font-size:0.95em;">${c.nombre} ${c.apellido}</h3>
                        <p style="margin:2px 0;"><strong>DNI:</strong> ${c.dni}</p>
                        <p style="margin:2px 0;"><strong>Tel:</strong> ${c.telefono || 'N/A'}</p>
                        <p style="margin:2px 0;"><strong>Email:</strong> ${c.email || 'N/A'}</p>
                        ${esAdmin ? `
                            <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
                                <button class="btn btn-secondary" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="editarClientePrompt(${c.id}, '${c.nombre}', '${c.apellido}', '${c.telefono || ''}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-danger" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="eliminarCliente(${c.id})">üóëÔ∏è</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') : '<p class="empty-message">No hay clientes</p>';
            } catch (e) {
                document.getElementById('clientesList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }
        
        // Funciones de edici√≥n de veh√≠culos y clientes
        function editarVehiculoPrompt(id, marca, modelo, precio, estado) {
            const nuevoPrecio = prompt(`Nuevo precio para ${marca} ${modelo} (actual: $${precio.toLocaleString()}):`, precio);
            const nuevoEstado = prompt(`Nuevo estado (actual: ${estado}). Opciones: disponible, reservado, vendido:`, estado);
            
            if (nuevoPrecio === null && nuevoEstado === null) return;
            
            const payload = { usuario_id: currentUser?.id };
            if (nuevoPrecio && nuevoPrecio !== String(precio)) payload.precio = Number(nuevoPrecio);
            if (nuevoEstado && nuevoEstado !== estado) payload.estado = nuevoEstado;
            
            if (Object.keys(payload).length > 1) {
                apiCall(`/api/vehiculos/${id}`, 'PUT', payload).then(res => {
                    alert('‚úÖ Veh√≠culo actualizado');
                    cargarVehiculos();
                }).catch(err => alert('‚ùå Error: ' + err.message));
            }
        }
        
        function editarClientePrompt(id, nombre, apellido, telefono) {
            const nuevoTelefono = prompt(`Nuevo tel√©fono para ${nombre} ${apellido} (actual: ${telefono}):`, telefono);
            
            if (nuevoTelefono === null) return;
            
            const payload = { usuario_id: currentUser?.id };
            if (nuevoTelefono && nuevoTelefono !== telefono) payload.telefono = nuevoTelefono;
            
            if (Object.keys(payload).length > 1) {
                apiCall(`/api/clientes/${id}`, 'PUT', payload).then(res => {
                    alert('‚úÖ Cliente actualizado');
                    cargarClientes();
                }).catch(err => alert('‚ùå Error: ' + err.message));
            }
        }
        
        async function eliminarVehiculo(id) {
            if (!confirm('¬øEliminar este veh√≠culo?')) return;
            try {
                await apiCall(`/api/vehiculos/${id}`, 'DELETE', { usuario_id: currentUser?.id });
                alert('‚úÖ Veh√≠culo eliminado');
                cargarVehiculos();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
        
        async function eliminarCliente(id) {
            if (!confirm('¬øEliminar este cliente?')) return;
            try {
                await apiCall(`/api/clientes/${id}`, 'DELETE', { usuario_id: currentUser?.id });
                alert('‚úÖ Cliente eliminado');
                cargarClientes();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function cargarMinutas() {
            try {
                const minutas = await apiCall('/api/minutas');
                const container = document.getElementById('minutasList');
                container.innerHTML = minutas.length ? minutas.map(m => `
                    <div class="card">
                        <h3>Minuta #${m.id}</h3>
                        <p><strong>Veh√≠culo:</strong> ${m.marca} ${m.modelo}</p>
                        <p><strong>Cliente:</strong> ${m.cliente_nombre} ${m.cliente_apellido}</p>
                        <p><strong>Precio:</strong> $${m.precio_final?.toLocaleString() || 'N/A'}</p>
                        <p><strong>Financiamiento:</strong> ${m.financiamiento || 'Ninguno'}</p>
                        <p><strong>Reserva:</strong> $${(m.reserva_monto || 0).toLocaleString()}</p>
                        ${m.tradein_proporciona ? `<p><strong>Trade-in:</strong> ${m.tradein_datos || '-'}</p>` : ''}
                        ${currentUser && (currentUser.es_premium || currentUser.super_admin || currentUser.rol === 'administrador' || currentUser.rol === 'admin') ? `
                            <div style="margin-top:10px;">
                                <button class="btn btn-danger" onclick="eliminarMinuta(${m.id})">üóëÔ∏è Eliminar</button>
                                <button class="btn btn-secondary" onclick="editarMinutaPrompt(${m.id})">‚úèÔ∏è Editar</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') : '<p class="empty-message">No hay minutas</p>';
            } catch (e) {
                document.getElementById('minutasList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        function editarMinutaPrompt(id) {
            const nuevoPrecio = prompt('Nuevo precio final (dejar vac√≠o para no modificar)');
            const nuevasObs = prompt('Nuevas observaciones (dejar vac√≠o para no modificar)');
            const reserva = prompt('Actualizar monto de reserva (dejar vac√≠o para no modificar)');
            const payload = { usuario_id: currentUser?.id };
            if (nuevoPrecio) payload.precio_final = Number(nuevoPrecio);
            if (nuevasObs) payload.observaciones = nuevasObs;
            if (reserva) payload.reserva_monto = Number(reserva);
            if (Object.keys(payload).length > 1) {
                apiCall(`/api/minutas/${id}`, 'PUT', payload).then(res => {
                    alert(res.message || 'Minuta actualizada');
                    cargarMinutas();
                }).catch(err => alert('Error: ' + err.message));
            }
        }

        function toggleMinutaForm() {
            const form = document.getElementById('minutaForm');
            form.style.display = (form.style.display === 'none' || !form.style.display) ? 'block' : 'none';
            if (form.style.display === 'block') loadMinutaOptions();
        }

        async function loadMinutaOptions() {
            try {
                const vehiculos = await apiCall('/api/vehiculos');
                const clientes = await apiCall('/api/clientes');

                const vehiculosDisponibles = vehiculos.filter(v => v.estado === 'disponible');

                const vehiculoSelect = document.getElementById('minVehiculo');
                const clienteSelect = document.getElementById('minCliente');

                vehiculoSelect.innerHTML = '<option value="">Seleccionar veh√≠culo...</option>' + vehiculosDisponibles.map(v => `
                    <option value="${v.id}" data-precio="${v.precio}">${v.marca} ${v.modelo} (${v.anio}) - $${v.precio?.toLocaleString()}</option>
                `).join('');

                clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' + clientes.map(c => `
                    <option value="${c.id}">${c.nombre} ${c.apellido} - DNI: ${c.dni}</option>
                `).join('');

                document.getElementById('minVehiculo').addEventListener('change', (e) => {
                    const opt = e.target.options[e.target.selectedIndex];
                    const precio = opt ? opt.getAttribute('data-precio') : '';
                    document.getElementById('minPrecioOriginal').value = precio || '';
                    document.getElementById('minPrecioFinal').value = precio || '';
                });
            } catch (err) {
                console.error('Error cargando opciones de minuta:', err);
            }
        }

        async function submitMinuta() {
            const vehiculo_id = parseInt(document.getElementById('minVehiculo').value);
            const cliente_id = parseInt(document.getElementById('minCliente').value);
            const precio_original = parseFloat(document.getElementById('minPrecioOriginal').value);
            const precio_final = parseFloat(document.getElementById('minPrecioFinal').value);
            const observaciones = document.getElementById('minObservaciones').value;
            const financiamiento = document.getElementById('minFinanciamiento').value;
            const financiamiento_anticipo = parseFloat(document.getElementById('minFinAnticipo').value) || 0;
            const financiamiento_cuotas = parseInt(document.getElementById('minFinCuotas').value) || 0;
            const financiamiento_precio = parseFloat(document.getElementById('minFinPrecio').value) || 0;
            const tradein_proporciona = document.getElementById('minTradein').checked;
            const tradein_datos = document.getElementById('minTradeinDatos').value;
            const reserva_monto = parseFloat(document.getElementById('minReservaMonto').value) || 0;

            if (!vehiculo_id || !cliente_id || !precio_original || !precio_final) {
                alert('‚ö†Ô∏è Completa todos los campos');
                return;
            }

            if (!currentUser || !currentUser.id) {
                alert('‚ö†Ô∏è Debes iniciar sesi√≥n para crear una minuta.');
                return;
            }

            try {
                const payload = { vehiculo_id, cliente_id, vendedor_id: currentUser?.id || null, precio_original, precio_final, observaciones,
                    financiamiento, financiamiento_anticipo, financiamiento_cuotas, financiamiento_precio,
                    tradein_proporciona, tradein_datos, reserva_monto };

                const result = await apiCall('/api/minutas', 'POST', payload);
                if (result && result.minuta) {
                    alert('‚úÖ Minuta creada');
                    toggleMinutaForm();
                    cargarMinutas();
                } else {
                    alert('‚ùå ' + (result.message || 'Error al crear minuta'));
                }
            } catch (err) {
                alert('‚ùå Error al crear minuta: ' + err.message);
            }
        }

        async function eliminarMinuta(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta minuta?')) return;
            if (!currentUser || !currentUser.id) {
                alert('‚ö†Ô∏è Debes iniciar sesi√≥n para eliminar minutas');
                return;
            }
            try {
                const res = await apiCall(`/api/minutas/${id}`, 'DELETE', { usuario_id: currentUser.id });
                if (res && res.message) {
                    alert('‚úÖ ' + res.message);
                    cargarMinutas();
                } else {
                    alert('‚ùå Error: ' + (res.message || 'No se pudo eliminar minuta'));
                }
            } catch (e) {
                alert('‚ùå Error al eliminar minuta: ' + e.message);
            }
        }

        async function cargarUsuarios() {
            if (!currentUser?.es_premium) return;
            
            try {
                const usuarios = await apiCall('/api/usuarios/todos');
                const container = document.getElementById('usuariosList');
                
                // Actualizar resumen
                actualizarResumenActividad();
                
                container.innerHTML = usuarios.length ? usuarios.map(u => `
                    <div class="card usuario-card ${u.habilitado ? 'activo' : 'suspendido'}" style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                            <div style="flex:1; min-width:150px;">
                                <h3 style="margin:0 0 5px 0; font-size:1em;">${u.es_premium ? '‚≠ê ' : ''}${u.nombre}</h3>
                                <p style="margin:2px 0; font-size:0.85em;"><strong>Email:</strong> ${u.email}</p>
                                <p style="margin:2px 0; font-size:0.85em;"><strong>Rol:</strong> ${u.rol}</p>
                                <p style="margin:2px 0; font-size:0.85em;">
                                    <strong>Estado:</strong> ${u.habilitado ? '<span style="color:#28a745">üü¢ Activo</span>' : '<span style="color:#dc3545">üî¥ Suspendido</span>'}
                                </p>
                                ${u.ultima_actividad ? `<p style="margin:2px 0; font-size:0.8em; color:#666;">üìÖ √öltima actividad: ${new Date(u.ultima_actividad).toLocaleString()}</p>` : ''}
                                ${u.minutas_count !== undefined ? `<p style="margin:2px 0; font-size:0.85em;">üìã Minutas: <strong>${u.minutas_count || 0}</strong></p>` : ''}
                            </div>
                        </div>
                        ${!u.es_premium ? `
                            <div style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;">
                                ${u.habilitado ? 
                                    `<button class="btn btn-danger" style="padding:8px 12px; width:auto; font-size:0.8em; flex:1;" onclick="suspenderUsuario(${u.id})">üö´ Suspender</button>` :
                                    `<button class="btn btn-success" style="padding:8px 12px; width:auto; font-size:0.8em; flex:1;" onclick="reactivarUsuario(${u.id})">‚úÖ Reactivar</button>`
                                }
                                <button class="btn btn-secondary" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="verSesiones(${u.id})">üïí Sesiones</button>
                                <button class="btn btn-secondary" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="verNavegacion(${u.id})">üìç Navegaci√≥n</button>
                                <button class="btn btn-primary" style="padding:8px 12px; width:auto; font-size:0.8em;" onclick="verResumenUsuario(${u.id}, '${u.nombre}')">üìä Resumen</button>
                            </div>
                        ` : '<p style="font-size:0.8em; color:#667eea; margin-top:8px;">üëë Usuario Premium (Administrador Principal)</p>'}
                    </div>
                `).join('') : '<p class="empty-message">No hay usuarios registrados</p>';
            } catch (e) {
                document.getElementById('usuariosList').innerHTML = '<p class="empty-message">Error al cargar usuarios</p>';
            }
        }
        
        async function actualizarResumenActividad() {
            try {
                const [usuarios, minutas, auditoria] = await Promise.all([
                    apiCall('/api/usuarios/todos').catch(() => []),
                    apiCall('/api/minutas').catch(() => []),
                    apiCall('/api/auditoria').catch(() => [])
                ]);
                
                const hoy = new Date().toDateString();
                
                // Total usuarios
                document.getElementById('totalUsuarios').textContent = usuarios.length || 0;
                
                // Usuarios activos hoy (basado en √∫ltima actividad)
                const activosHoy = usuarios.filter(u => u.ultima_actividad && new Date(u.ultima_actividad).toDateString() === hoy).length;
                document.getElementById('usuariosActivos').textContent = activosHoy;
                
                // Minutas de hoy
                const minutasHoy = minutas.filter(m => m.fecha_creacion && new Date(m.fecha_creacion).toDateString() === hoy).length;
                document.getElementById('minutasHoy').textContent = minutasHoy;
                
                // Acciones de hoy
                const accionesHoy = auditoria.filter(a => {
                    const fecha = a.fecha_dispositivo || a.fecha_accion;
                    return fecha && new Date(fecha).toDateString() === hoy;
                }).length;
                document.getElementById('accionesHoy').textContent = accionesHoy;
                
            } catch (e) {
                console.error('Error actualizando resumen:', e);
            }
        }
        
        async function verResumenUsuario(usuarioId, nombre) {
            try {
                const [sesiones, navegacion] = await Promise.all([
                    apiCall(`/api/tracking/sesiones/${usuarioId}`).catch(() => []),
                    apiCall(`/api/tracking/navegacion/${usuarioId}`).catch(() => [])
                ]);
                
                const totalSesiones = sesiones.length;
                const ultimaSesion = sesiones[0] ? new Date(sesiones[0].fecha_login).toLocaleString() : 'Nunca';
                const totalNavegaciones = navegacion.length;
                
                // Contar secciones m√°s visitadas
                const seccionesCount = {};
                navegacion.forEach(n => {
                    seccionesCount[n.seccion_visitada] = (seccionesCount[n.seccion_visitada] || 0) + 1;
                });
                const topSecciones = Object.entries(seccionesCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([s, c]) => `${s}: ${c}`)
                    .join(', ') || 'Sin datos';
                
                const html = `
                    <div class="card" style="background:#e3f2fd;">
                        <h3>üìä Resumen de ${nombre}</h3>
                        <p><strong>Total sesiones:</strong> ${totalSesiones}</p>
                        <p><strong>√öltima sesi√≥n:</strong> ${ultimaSesion}</p>
                        <p><strong>Total navegaciones:</strong> ${totalNavegaciones}</p>
                        <p><strong>Secciones m√°s visitadas:</strong> ${topSecciones}</p>
                    </div>
                `;
                
                document.getElementById('alertasBox').style.display = 'block';
                document.getElementById('alertasList').innerHTML = html;
            } catch (e) {
                alert('‚ùå Error al obtener resumen: ' + e.message);
            }
        }

        async function cargarAuditoria() {
            if (!currentUser?.es_premium) return;
            
            try {
                const auditoria = await apiCall('/api/auditoria');
                const container = document.getElementById('auditoriaBody');
                
                container.innerHTML = auditoria.slice(0, 30).map(a => `
                    <tr>
                        <td style="padding:5px; font-size:0.75em">${new Date(a.fecha_dispositivo || a.fecha_accion || Date.now()).toLocaleString()}</td>
                        <td style="padding:5px">${a.usuario_nombre || 'Sistema'}</td>
                        <td style="padding:5px">${a.accion}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Sin registros</td></tr>';
            } catch (e) {
                document.getElementById('auditoriaBody').innerHTML = '<tr><td colspan="3">Error</td></tr>';
            }
        }

        // Nuevas funciones: alertas y control de usuario
        async function cargarAlertasRecientes() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo administradores premium pueden ver alertas');
                return;
            }
            try {
                const alertas = await apiCall('/api/alertas-premium');
                document.getElementById('alertasBox').style.display = 'block';
                const container = document.getElementById('alertasList');
                container.innerHTML = alertas.length ? alertas.map(a => `
                    <div class="card">
                        <h3>${a.titulo}</h3>
                        <p>${a.mensaje}</p>
                        <p style="font-size:0.8em; color:#666">${new Date(a.fecha_alerta).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay alertas</p>';
            } catch (e) {
                alert('‚ùå Error al cargar alertas: ' + e.message);
            }
        }

        async function cargarNotificaciones() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo administradores premium pueden ver notificaciones');
                return;
            }
            try {
                const nots = await apiCall('/api/notificaciones');
                document.getElementById('notificacionesBox').style.display = 'block';
                const container = document.getElementById('notificacionesList');
                container.innerHTML = nots.length ? nots.map(n => `
                    <div class="card">
                        <h3>${n.titulo}</h3>
                        <p>${n.mensaje}</p>
                        <p style="font-size:0.8em; color:#666">${new Date(n.created_at).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay notificaciones</p>';
            } catch (e) {
                alert('‚ùå Error al cargar notificaciones: ' + e.message);
            }
        }

        async function verSesiones(usuarioId) {
            try {
                const sesiones = await apiCall(`/api/tracking/sesiones/${usuarioId}`);
                const html = sesiones.length ? sesiones.map(s => `
                    <div class="card">
                        <h3>Sesi√≥n #${s.id}</h3>
                        <p><strong>Login:</strong> ${new Date(s.fecha_login).toLocaleString()}</p>
                        <p><strong>Logout:</strong> ${s.fecha_logout ? new Date(s.fecha_logout).toLocaleString() : 'Activa'}</p>
                        <p><strong>IP:</strong> ${s.ip_address || 'N/A'}</p>
                        <p><strong>Duraci√≥n (s):</strong> ${s.duracion_segundos || '-'}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay sesiones</p>';

                // Mostrar en un modal ligero (reutilizamos alertasBox)
                document.getElementById('alertasBox').style.display = 'block';
                document.getElementById('alertasList').innerHTML = `<h4>üïí Sesiones del usuario ${usuarioId}</h4>` + html;
            } catch (e) {
                alert('‚ùå Error al obtener sesiones: ' + e.message);
            }
        }

        async function verNavegacion(usuarioId) {
            try {
                const nav = await apiCall(`/api/tracking/navegacion/${usuarioId}`);
                const html = nav.length ? nav.map(n => `
                    <div class="card">
                        <h3>${n.seccion_visitada}</h3>
                        <p><strong>Acci√≥n:</strong> ${n.accion}</p>
                        <p><strong>Detalles:</strong> ${n.detalles || '-'}</p>
                        <p style="font-size:0.8em; color:#666">${new Date(n.fecha_visita).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay navegaci√≥n registrada</p>';

                document.getElementById('alertasBox').style.display = 'block';
                document.getElementById('alertasList').innerHTML = `<h4>üìç Navegaci√≥n del usuario ${usuarioId}</h4>` + html;
            } catch (e) {
                alert('‚ùå Error al obtener navegaci√≥n: ' + e.message);
            }
        }

        async function suspenderUsuario(id) {
            const motivo = prompt('Motivo de la suspensi√≥n:');
            if (!motivo) return;
            
            try {
                await apiCall(`/api/usuarios/${id}/suspender`, 'POST', {
                    motivo,
                    mensaje: 'Cuenta suspendida',
                    duracion: 'indefinido',
                    usuario_premium_id: currentUser.id
                });
                alert('‚úÖ Usuario suspendido');
                cargarUsuarios();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function reactivarUsuario(id) {
            if (!confirm('¬øReactivar usuario?')) return;
            
            try {
                await apiCall(`/api/usuarios/${id}/reactivar`, 'POST', {
                    usuario_premium_id: currentUser.id
                });
                alert('‚úÖ Usuario reactivado');
                cargarUsuarios();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function agregarVehiculo(event) {
            event.preventDefault();
            
            try {
                const payload = {
                    tipo: document.getElementById('vehTipo').value,
                    marca: document.getElementById('vehMarca').value,
                    modelo: document.getElementById('vehModelo').value,
                    version: document.getElementById('vehVersion').value,
                    anio: document.getElementById('vehAnio').value,
                    condicion: document.getElementById('vehCondicion').value,
                    precio: document.getElementById('vehPrecio').value,
                    dominio: document.getElementById('vehDominio').value
                };

                const fileInput = document.getElementById('vehImagen');
                if (fileInput && fileInput.files && fileInput.files.length) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    const base64 = await new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    payload.imagen_base64 = base64;
                }

                const result = await apiCall('/api/vehiculos', 'POST', payload);
                if (result && result.vehiculo) {
                    alert('‚úÖ Veh√≠culo agregado');
                    event.target.reset();
                    cargarVehiculos();
                } else {
                    alert('‚ùå ' + (result.message || 'Error al agregar veh√≠culo'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + (e.message || e));
            }
        }

        async function agregarCliente(event) {
            event.preventDefault();
            
            try {
                await apiCall('/api/clientes', 'POST', {
                    nombre: document.getElementById('cliNombre').value,
                    apellido: document.getElementById('cliApellido').value,
                    dni: document.getElementById('cliDni').value,
                    telefono: document.getElementById('cliTelefono').value,
                    email: document.getElementById('cliEmail').value,
                    direccion: document.getElementById('cliDireccion').value
                });
                alert('‚úÖ Cliente agregado');
                event.target.reset();
                cargarClientes();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const savedIP = localStorage.getItem('serverIP');
            if (savedIP) {
                document.getElementById('serverIP').value = savedIP;
            }
            // Restore persisted user if any
            try {
                const saved = localStorage.getItem('currentUser');
                if (saved) {
                    currentUser = JSON.parse(saved);
                    document.getElementById('userInfo').textContent = `${currentUser.nombre} (${currentUser.rol})`;
                    showMainMenu(true);
                    // optionally load dashboard data
                    showSection('dashboard');
                } else {
                    showMainMenu(false);
                }
            } catch (e) {
                showMainMenu(false);
            }
        });

        // Funciones de descarga
        function descargarExcel() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo el administrador premium puede exportar');
                return;
            }
            API_URL = getServerURL();
            window.open(`${API_URL}/api/exportar-excel`, '_blank');
        }

        async function descargarJSON() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo el administrador premium puede exportar');
                return;
            }
            try {
                const datos = await apiCall('/api/exportar-datos');
                const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `concesionaria_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('‚úÖ Archivo JSON descargado. S√∫belo a Google Drive para respaldo.');
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        // ========================================
        // MINUTA PROFESIONAL - Funciones
        // ========================================
        
        let firmaActual = null; // 'vendedor' o 'comprador'
        let firmaContext = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function toggleMinutaProfesional() {
            const form = document.getElementById('minutaProfesionalForm');
            const isVisible = form.style.display !== 'none';
            form.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Inicializar fecha con hoy
                document.getElementById('mpFecha').value = new Date().toISOString().split('T')[0];
                // Inicializar vendedor con usuario actual
                if (currentUser) {
                    document.getElementById('mpVendedorNombre').value = currentUser.nombre || '';
                }
                // Habilitar botones de firma seg√∫n rol
                actualizarPermisosFirma();
            }
        }

        function actualizarPermisosFirma() {
            const esAdminPremium = currentUser && (currentUser.es_premium || currentUser.super_admin || currentUser.rol === 'administrador');
            const btnVendedor = document.getElementById('btnFirmaVendedor');
            const btnComprador = document.getElementById('btnFirmaComprador');
            
            if (esAdminPremium) {
                btnVendedor.disabled = false;
                btnComprador.disabled = false;
                btnVendedor.style.opacity = '1';
                btnComprador.style.opacity = '1';
            } else {
                btnVendedor.disabled = true;
                btnComprador.disabled = true;
                btnVendedor.style.opacity = '0.5';
                btnComprador.style.opacity = '0.5';
            }
        }

        // Campos condicionales
        function toggleReservaMonto() {
            const box = document.getElementById('mpReservaMontoBox');
            box.style.display = document.getElementById('mpCondReserva').checked ? 'block' : 'none';
        }

        function toggleFinanciacionCampos() {
            const box = document.getElementById('mpFinanciacionBox');
            box.style.display = document.getElementById('mpCondFinanciacion').checked ? 'block' : 'none';
        }

        function toggleTarjetaCuotas() {
            const box = document.getElementById('mpTarjetaCuotasBox');
            box.style.display = document.getElementById('mpCondTarjeta').checked ? 'block' : 'none';
        }

        function togglePermutaCampos() {
            const box = document.getElementById('mpPermutaBox');
            box.style.display = document.getElementById('mpCondPermuta').checked ? 'block' : 'none';
        }

        function toggleOtroCampo() {
            const box = document.getElementById('mpOtroBox');
            box.style.display = document.getElementById('mpCondOtro').checked ? 'block' : 'none';
        }

        // Firma Digital
        function abrirFirma(tipo) {
            const esAdminPremium = currentUser && (currentUser.es_premium || currentUser.super_admin || currentUser.rol === 'administrador');
            if (!esAdminPremium) {
                alert('‚ö†Ô∏è Solo administradores premium pueden editar firmas');
                return;
            }
            
            firmaActual = tipo;
            document.getElementById('firmaModal').style.display = 'block';
            
            const canvas = document.getElementById('firmaCanvas');
            firmaContext = canvas.getContext('2d');
            firmaContext.fillStyle = 'white';
            firmaContext.fillRect(0, 0, canvas.width, canvas.height);
            firmaContext.strokeStyle = '#333';
            firmaContext.lineWidth = 2;
            firmaContext.lineCap = 'round';
            
            // Event listeners para dibujar
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            firmaContext.beginPath();
            firmaContext.moveTo(lastX, lastY);
            firmaContext.lineTo(x, y);
            firmaContext.stroke();
            
            lastX = x;
            lastY = y;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            isDrawing = true;
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            firmaContext.beginPath();
            firmaContext.moveTo(lastX, lastY);
            firmaContext.lineTo(x, y);
            firmaContext.stroke();
            
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function limpiarFirma() {
            const canvas = document.getElementById('firmaCanvas');
            firmaContext.fillStyle = 'white';
            firmaContext.fillRect(0, 0, canvas.width, canvas.height);
        }

        function confirmarFirma() {
            const canvas = document.getElementById('firmaCanvas');
            const dataURL = canvas.toDataURL('image/png');
            
            // Copiar al canvas correspondiente
            const targetCanvas = document.getElementById(firmaActual === 'vendedor' ? 'mpFirmaVendedor' : 'mpFirmaComprador');
            const targetCtx = targetCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                targetCanvas.width = targetCanvas.offsetWidth;
                targetCanvas.height = targetCanvas.offsetHeight;
                targetCtx.drawImage(img, 0, 0, targetCanvas.width, targetCanvas.height);
            };
            img.src = dataURL;
            
            cerrarFirma();
        }

        function cerrarFirma() {
            document.getElementById('firmaModal').style.display = 'none';
            firmaActual = null;
        }

        // Obtener condiciones seleccionadas
        function obtenerCondiciones() {
            const condiciones = [];
            if (document.getElementById('mpCondContado').checked) condiciones.push('Contado efectivo');
            if (document.getElementById('mpCondReserva').checked) {
                const monto = document.getElementById('mpReservaMonto').value;
                condiciones.push(`Reserva ($${Number(monto).toLocaleString() || 0})`);
            }
            if (document.getElementById('mpCondAnticipo').checked) condiciones.push('Anticipo + Saldo pendiente');
            if (document.getElementById('mpCondCredito').checked) condiciones.push('Cr√©dito interno');
            if (document.getElementById('mpCondFinanciacion').checked) {
                const financiera = document.getElementById('mpFinanciera').value;
                const cuotas = document.getElementById('mpFinCuotas').value;
                condiciones.push(`Financiaci√≥n: ${financiera || 'N/A'} - ${cuotas || 0} cuotas`);
            }
            if (document.getElementById('mpCondTarjeta').checked) {
                const cuotas = document.getElementById('mpTarjetaCuotas').value;
                condiciones.push(`Tarjeta de cr√©dito: ${cuotas || 0} cuotas`);
            }
            if (document.getElementById('mpCondPermuta').checked) {
                const datos = document.getElementById('mpPermutaDatos').value;
                const valor = document.getElementById('mpPermutaValor').value;
                condiciones.push(`Permuta: ${datos || 'N/A'} - Valor: $${Number(valor).toLocaleString() || 0}`);
            }
            if (document.getElementById('mpCondOtro').checked) {
                const otro = document.getElementById('mpOtroTexto').value;
                condiciones.push(`Otro: ${otro || 'N/A'}`);
            }
            return condiciones;
        }

        // Recopilar datos del formulario
        function recopilarDatosMinuta() {
            return {
                lugar: document.getElementById('mpLugar').value,
                fecha: document.getElementById('mpFecha').value,
                comprador: {
                    nombre: document.getElementById('mpCompradorNombre').value,
                    dni: document.getElementById('mpCompradorDni').value,
                    domicilio: document.getElementById('mpCompradorDomicilio').value,
                    telefono: document.getElementById('mpCompradorTelefono').value,
                    email: document.getElementById('mpCompradorEmail').value
                },
                vendedor: {
                    nombre: document.getElementById('mpVendedorNombre').value
                },
                vehiculo: {
                    marca: document.getElementById('mpVehiculoMarca').value,
                    modelo: document.getElementById('mpVehiculoModelo').value,
                    anio: document.getElementById('mpVehiculoAnio').value,
                    dominio: document.getElementById('mpVehiculoDominio').value,
                    motor: document.getElementById('mpVehiculoMotor').value,
                    chasis: document.getElementById('mpVehiculoChasis').value
                },
                condiciones: obtenerCondiciones(),
                precioFinal: document.getElementById('mpPrecioFinal').value,
                observaciones: document.getElementById('mpObservaciones').value,
                firmaVendedor: document.getElementById('mpFirmaVendedor').toDataURL?.() || null,
                firmaComprador: document.getElementById('mpFirmaComprador').toDataURL?.() || null
            };
        }

        // Validar campos obligatorios
        function validarMinutaProfesional(datos) {
            if (!datos.comprador.nombre) return 'Falta nombre del comprador';
            if (!datos.comprador.dni) return 'Falta DNI/CUIT del comprador';
            if (!datos.vendedor.nombre) return 'Falta nombre del vendedor';
            if (!datos.vehiculo.marca) return 'Falta marca del veh√≠culo';
            if (!datos.vehiculo.modelo) return 'Falta modelo del veh√≠culo';
            if (!datos.vehiculo.anio) return 'Falta a√±o del veh√≠culo';
            if (!datos.precioFinal) return 'Falta precio final de venta';
            return null;
        }

        // Guardar minuta profesional
        async function guardarMinutaProfesional() {
            const datos = recopilarDatosMinuta();
            const error = validarMinutaProfesional(datos);
            
            if (error) {
                alert('‚ö†Ô∏è ' + error);
                return;
            }

            try {
                const payload = {
                    lugar: datos.lugar,
                    fecha: datos.fecha,
                    comprador: datos.comprador,
                    vendedor: datos.vendedor,
                    vehiculo: datos.vehiculo,
                    operacion: {
                        condiciones: datos.condiciones,
                        precioFinal: Number(datos.precioFinal)
                    },
                    observaciones: datos.observaciones,
                    firmaVendedor: datos.firmaVendedor,
                    firmaComprador: datos.firmaComprador,
                    estado: 'activa',
                    usuario_id: currentUser?.id
                };

                const result = await apiCall('/api/minutas/detallada', 'POST', payload);
                
                if (result && result.minuta_id) {
                    alert('‚úÖ Minuta profesional guardada correctamente');
                    toggleMinutaProfesional();
                    cargarMinutas();
                } else {
                    alert('‚ùå ' + (result.message || 'Error al guardar minuta'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        // Previsualizar minuta
        function previsualizarMinuta() {
            const datos = recopilarDatosMinuta();
            const error = validarMinutaProfesional(datos);
            
            if (error) {
                alert('‚ö†Ô∏è ' + error);
                return;
            }

            const html = generarHTMLMinuta(datos);
            document.getElementById('previsualizacionContenido').innerHTML = html;
            document.getElementById('previsualizacionModal').style.display = 'block';
        }

        function generarHTMLMinuta(datos) {
            const fechaFormateada = datos.fecha ? new Date(datos.fecha).toLocaleDateString('es-AR') : 'N/A';
            
            return `
                <div style="font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4;">
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 18px;">MINUTA DE VENTA DE VEH√çCULO</h2>
                        <p style="margin: 5px 0 0 0; color: #666;">De Grazia - Automotores</p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p><strong>Lugar:</strong> ${datos.lugar || 'N/A'} | <strong>Fecha:</strong> ${fechaFormateada}</p>
                    </div>

                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">DATOS DEL COMPRADOR</h4>
                        <p style="margin: 3px 0;"><strong>Nombre:</strong> ${datos.comprador.nombre}</p>
                        <p style="margin: 3px 0;"><strong>DNI/CUIT:</strong> ${datos.comprador.dni}</p>
                        <p style="margin: 3px 0;"><strong>Domicilio:</strong> ${datos.comprador.domicilio || 'N/A'}</p>
                        <p style="margin: 3px 0;"><strong>Tel:</strong> ${datos.comprador.telefono || 'N/A'} | <strong>Email:</strong> ${datos.comprador.email || 'N/A'}</p>
                    </div>

                    <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">DATOS DEL VENDEDOR</h4>
                        <p style="margin: 3px 0;"><strong>Nombre:</strong> ${datos.vendedor.nombre}</p>
                    </div>

                    <div style="background: #fff3e0; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">DATOS DEL VEH√çCULO</h4>
                        <p style="margin: 3px 0;"><strong>Marca:</strong> ${datos.vehiculo.marca} | <strong>Modelo:</strong> ${datos.vehiculo.modelo} | <strong>A√±o:</strong> ${datos.vehiculo.anio}</p>
                        <p style="margin: 3px 0;"><strong>Dominio:</strong> ${datos.vehiculo.dominio || 'N/A'}</p>
                        <p style="margin: 3px 0;"><strong>Motor:</strong> ${datos.vehiculo.motor || 'N/A'} | <strong>Chasis:</strong> ${datos.vehiculo.chasis || 'N/A'}</p>
                    </div>

                    <div style="background: #fce4ec; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">CONDICIONES DE LA OPERACI√ìN</h4>
                        ${datos.condiciones.length ? datos.condiciones.map(c => `<p style="margin: 3px 0;">‚Ä¢ ${c}</p>`).join('') : '<p>Sin condiciones especificadas</p>'}
                    </div>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px; text-align: center;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">PRECIO TOTAL DE VENTA</h4>
                        <p style="font-size: 24px; font-weight: bold; margin: 0; color: #1976d2;">$${Number(datos.precioFinal).toLocaleString('es-AR')}</p>
                    </div>

                    ${datos.observaciones ? `
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">OBSERVACIONES</h4>
                        <p style="margin: 0;">${datos.observaciones}</p>
                    </div>
                    ` : ''}

                    <div style="display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc;">
                        <div style="text-align: center; flex: 1;">
                            <div style="border-bottom: 1px solid #333; height: 60px; margin-bottom: 5px;"></div>
                            <p style="margin: 0; font-size: 11px;"><strong>Firma del Vendedor</strong></p>
                        </div>
                        <div style="width: 40px;"></div>
                        <div style="text-align: center; flex: 1;">
                            <div style="border-bottom: 1px solid #333; height: 60px; margin-bottom: 5px;"></div>
                            <p style="margin: 0; font-size: 11px;"><strong>Firma del Comprador</strong></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function cerrarPrevisualizacion() {
            document.getElementById('previsualizacionModal').style.display = 'none';
        }

        function imprimirMinuta() {
            const contenido = document.getElementById('previsualizacionContenido').innerHTML;
            const ventana = window.open('', '_blank');
            ventana.document.write(`
                <html>
                <head>
                    <title>Minuta de Venta</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${contenido}
                    <script>window.print(); window.close();</script>
                </body>
                </html>
            `);
            ventana.document.close();
        }

        function exportarPDF() {
            // Para una implementaci√≥n real se usar√≠a una librer√≠a como jsPDF
            // Por ahora usamos la funci√≥n de impresi√≥n que permite guardar como PDF
            alert('üí° En la ventana de impresi√≥n, selecciona "Guardar como PDF" como destino');
            imprimirMinuta();
        }
    </script>
</body>
</html>
