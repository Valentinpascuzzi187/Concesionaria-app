<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Concesionaria Pro</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.3em;
            color: #333;
            text-align: center;
        }

        .header .user-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .nav-mobile {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 0.85em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .card h3 {
            font-size: 1em;
            color: #333;
            margin-bottom: 8px;
        }

        .card p {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .estado-disponible { color: #28a745; font-weight: bold; }
        .estado-reservado { color: #ffc107; font-weight: bold; }
        .estado-vendido { color: #dc3545; font-weight: bold; }

        .usuario-card.activo { border-left-color: #28a745; }
        .usuario-card.suspendido { border-left-color: #dc3545; }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 1.2em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .config-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #ffc107;
        }

        .config-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .config-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffc107;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Concesionaria Pro</h1>
            <div class="user-info" id="userInfo">No conectado</div>
        </div>

        <nav class="nav-mobile" id="mainNav" style="display: none;">
            <button class="nav-btn" onclick="showSection('dashboard')">üè† Inicio</button>
            <button class="nav-btn" onclick="showSection('vehiculos')">üöó Stock</button>
            <button class="nav-btn" onclick="showSection('clientes')">üë• Clientes</button>
            <button class="nav-btn" onclick="showSection('minutas')">üìã Minutas</button>
            <button class="nav-btn premium-only" onclick="showSection('usuarios')">üë§ Usuarios</button>
            <button class="nav-btn premium-only" onclick="showSection('auditoria')">üîç Auditor√≠a</button>
        </nav>

        <!-- Login -->
        <section id="login" class="section active">
            <h2>üîê Iniciar Sesi√≥n</h2>
            
            <div class="config-box">
                <h4>‚öôÔ∏è Configuraci√≥n del Servidor</h4>
                <input type="text" id="serverIP" placeholder="IP del servidor" value="concesionaria-app-production.up.railway.app">
                <small style="color: #856404;">Servidor en la nube configurado autom√°ticamente</small>
            </div>

            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="loginEmail" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="Tu contrase√±a">
            </div>
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showSection('register')">Crear Cuenta</button>
        </section>

        <!-- Register -->
        <section id="register" class="section">
            <h2>üìù Crear Cuenta</h2>
            <div class="form-group">
                <label>üë§ Nombre</label>
                <input type="text" id="regNombre" placeholder="Tu nombre">
            </div>
            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="regEmail" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="regPassword" placeholder="Tu contrase√±a">
            </div>
            <div class="form-group">
                <label>üé≠ Rol</label>
                <select id="regRol">
                    <option value="vendedor">Vendedor</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="register()">Registrarse</button>
            <button class="btn btn-secondary" onclick="showSection('login')">Volver al Login</button>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="section">
            <h2>üè† Dashboard</h2>
            <div class="card">
                <h3>üëã Bienvenido</h3>
                <p>Usa el men√∫ superior para navegar por la aplicaci√≥n.</p>
            </div>
            <div class="card">
                <h3>üìä Resumen</h3>
                <p id="dashboardStats">Cargando estad√≠sticas...</p>
            </div>
        </section>

        <!-- Veh√≠culos -->
        <section id="vehiculos" class="section">
            <h2>üöó Stock de Veh√≠culos</h2>
            <div class="list-container" id="vehiculosList">
                <p class="empty-message">Cargando veh√≠culos...</p>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">‚ûï Agregar Veh√≠culo</h3>
            <form onsubmit="agregarVehiculo(event)">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="vehTipo" required>
                        <option value="auto">Auto</option>
                        <option value="camioneta">Camioneta</option>
                        <option value="moto">Moto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" id="vehMarca" required placeholder="Ej: Toyota">
                </div>
                <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" id="vehModelo" required placeholder="Ej: Corolla">
                </div>
                <div class="form-group">
                    <label>Versi√≥n</label>
                    <input type="text" id="vehVersion" placeholder="Ej: XEI">
                </div>
                <div class="form-group">
                    <label>A√±o</label>
                    <input type="number" id="vehAnio" required placeholder="2024">
                </div>
                <div class="form-group">
                    <label>Condici√≥n</label>
                    <select id="vehCondicion" required>
                        <option value="nuevo">Nuevo</option>
                        <option value="usado">Usado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Precio</label>
                    <input type="number" id="vehPrecio" required placeholder="25000000">
                </div>
                <div class="form-group">
                    <label>Dominio</label>
                    <input type="text" id="vehDominio" placeholder="ABC123">
                </div>
                <button type="submit" class="btn btn-success">Agregar Veh√≠culo</button>
            </form>
        </section>

        <!-- Clientes -->
        <section id="clientes" class="section">
            <h2>üë• Clientes</h2>
            <div class="list-container" id="clientesList">
                <p class="empty-message">Cargando clientes...</p>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">‚ûï Agregar Cliente</h3>
            <form onsubmit="agregarCliente(event)">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="cliNombre" required placeholder="Juan">
                </div>
                <div class="form-group">
                    <label>Apellido</label>
                    <input type="text" id="cliApellido" required placeholder="P√©rez">
                </div>
                <div class="form-group">
                    <label>DNI</label>
                    <input type="text" id="cliDni" required placeholder="12345678">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="cliTelefono" placeholder="1122334455">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="cliEmail" placeholder="cliente@email.com">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <input type="text" id="cliDireccion" placeholder="Calle 123">
                </div>
                <button type="submit" class="btn btn-success">Agregar Cliente</button>
            </form>
        </section>

        <!-- Minutas -->
        <section id="minutas" class="section">
            <h2>üìã Minutas</h2>
            <div class="list-container" id="minutasList">
                <p class="empty-message">Cargando minutas...</p>
            </div>
        </section>

        <!-- Usuarios (Premium) -->
        <section id="usuarios" class="section">
            <h2>üë§ Control de Usuarios</h2>
            <div class="list-container" id="usuariosList">
                <p class="empty-message">Cargando usuarios...</p>
            </div>
        </section>

        <!-- Auditor√≠a (Premium) -->
        <section id="auditoria" class="section">
            <h2>üîç Auditor√≠a</h2>
            
            <!-- Botones de Exportaci√≥n -->
            <div style="margin-bottom: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0;">üìä Exportar Datos</h4>
                <button class="btn btn-success" onclick="descargarExcel()" style="margin-right: 10px;">
                    üì• Descargar Excel
                </button>
                <button class="btn btn-primary" onclick="descargarJSON()">
                    üìÑ Descargar JSON
                </button>
                <p style="margin: 10px 0 0 0; font-size: 0.8em; color: #666;">
                    Descarga todos los datos para subir a Google Drive
                </p>
            </div>
            
            <div class="list-container">
                <table style="width: 100%; font-size: 0.8em;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 8px;">Fecha</th>
                            <th style="padding: 8px;">Usuario</th>
                            <th style="padding: 8px;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="auditoriaBody">
                        <tr><td colspan="3" class="empty-message">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">üö™</button>
    </div>

    <script>
        // Configuraci√≥n
        let API_URL = 'http://localhost:4000';
        let currentUser = null;
        let currentSessionId = null;

        function getServerURL() {
            // Detectar autom√°ticamente si estamos en producci√≥n o local
            const currentHost = window.location.hostname;
            const currentProtocol = window.location.protocol;
            
            // Si estamos en el mismo servidor (producci√≥n), usar la misma URL
            if (currentHost !== 'localhost' && currentHost !== '127.0.0.1' && !currentHost.startsWith('192.168')) {
                return `${currentProtocol}//${currentHost}`;
            }
            
            // Si hay IP configurada manualmente
            const serverIP = document.getElementById('serverIP').value || localStorage.getItem('serverIP') || 'localhost';
            localStorage.setItem('serverIP', serverIP);
            
            if (serverIP.includes('ngrok') || serverIP.includes('railway') || serverIP.includes('render')) {
                return `https://${serverIP}`;
            }
            return `http://${serverIP}:4000`;
        }

        // Funciones de navegaci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            if (currentUser && currentSessionId) {
                trackNavegacion(sectionId);
            }

            switch(sectionId) {
                case 'vehiculos': cargarVehiculos(); break;
                case 'clientes': cargarClientes(); break;
                case 'minutas': cargarMinutas(); break;
                case 'usuarios': cargarUsuarios(); break;
                case 'auditoria': cargarAuditoria(); break;
            }
        }

        function showMainMenu(show) {
            document.getElementById('mainNav').style.display = show ? 'flex' : 'none';
            document.getElementById('logoutBtn').style.display = show ? 'block' : 'none';
            
            // Mostrar botones premium solo para usuarios premium
            document.querySelectorAll('.premium-only').forEach(btn => {
                btn.style.display = (show && currentUser && currentUser.es_premium) ? 'inline-block' : 'none';
            });
            
            // Mostrar botones de administrador limitado
            document.querySelectorAll('.admin-only').forEach(btn => {
                btn.style.display = (show && currentUser && currentUser.es_admin) ? 'inline-block' : 'none';
            });
        }

        // Funci√≥n para obtener informaci√≥n del dispositivo
        function getDeviceInfo() {
            return {
                dispositivo_id: getDeviceId(),
                mac_address: 'N/A', // No se puede obtener MAC desde web por seguridad
                modelo: navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop',
                plataforma: navigator.platform,
                navegador: getBrowserName(),
                fecha_dispositivo: new Date().toISOString()
            };
        }

        function getDeviceId() {
            // Generar ID √∫nico basado en fingerprint del navegador
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency || 'N/A'
            ].join('|');
            
            // Hash simple del fingerprint
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'dev_' + Math.abs(hash).toString(16);
        }

        function getBrowserName() {
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            API_URL = getServerURL();
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(`${API_URL}${endpoint}`, options);
            return response.json();
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('‚ö†Ô∏è Ingresa email y contrase√±a');
                return;
            }

            try {
                API_URL = getServerURL();
                
                // Obtener informaci√≥n del dispositivo
                const dispositivoInfo = getDeviceInfo();
                console.log('üì± Info del dispositivo:', dispositivoInfo);
                
                const result = await apiCall('/api/auth/login', 'POST', { 
                    email, 
                    password, 
                    dispositivo_info: dispositivoInfo 
                });
                
                if (result.user) {
                    currentUser = result.user;
                    currentSessionId = result.user.sesion_id;
                    
                    // Guardar info del dispositivo para futuras auditor√≠as
                    localStorage.setItem('deviceInfo', JSON.stringify(dispositivoInfo));
                    
                    document.getElementById('userInfo').textContent = `${currentUser.nombre} (${currentUser.rol})`;
                    showMainMenu(true);
                    showSection('dashboard');
                    
                    alert('‚úÖ Bienvenido ' + currentUser.nombre);
                } else {
                    alert('‚ùå ' + (result.message || 'Error al iniciar sesi√≥n'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n. Verifica la IP del servidor.\n\n' + error.message);
            }
        }

        async function register() {
            const nombre = document.getElementById('regNombre').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const rol = document.getElementById('regRol').value;

            if (!nombre || !email || !password) {
                alert('‚ö†Ô∏è Completa todos los campos');
                return;
            }

            try {
                API_URL = getServerURL();
                const result = await apiCall('/api/auth/register', 'POST', { nombre, email, password, rol });
                
                if (result.user) {
                    alert('‚úÖ Usuario registrado correctamente');
                    showSection('login');
                } else {
                    alert('‚ùå ' + (result.message || 'Error al registrar'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        async function logout() {
            if (currentUser && currentSessionId) {
                try {
                    await apiCall('/api/auth/logout', 'POST', { 
                        usuario_id: currentUser.id, 
                        sesion_id: currentSessionId 
                    });
                } catch (e) {}
            }
            
            currentUser = null;
            currentSessionId = null;
            showMainMenu(false);
            showSection('login');
            document.getElementById('userInfo').textContent = 'No conectado';
        }

        async function trackNavegacion(seccion) {
            try {
                await apiCall('/api/tracking/navegacion', 'POST', {
                    sesion_id: currentSessionId,
                    usuario_id: currentUser.id,
                    seccion,
                    accion: 'visita',
                    detalles: {}
                });
            } catch (e) {}
        }

        // Data loading functions
        async function cargarVehiculos() {
            try {
                const vehiculos = await apiCall('/api/vehiculos');
                const container = document.getElementById('vehiculosList');
                
                container.innerHTML = vehiculos.length ? vehiculos.map(v => `
                    <div class="card">
                        <h3>${v.marca} ${v.modelo} ${v.version || ''}</h3>
                        <p><strong>A√±o:</strong> ${v.anio}</p>
                        <p><strong>Precio:</strong> $${v.precio?.toLocaleString() || 'N/A'}</p>
                        <p><strong>Estado:</strong> <span class="estado-${v.estado}">${v.estado}</span></p>
                    </div>
                `).join('') : '<p class="empty-message">No hay veh√≠culos</p>';
            } catch (e) {
                document.getElementById('vehiculosList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarClientes() {
            try {
                const clientes = await apiCall('/api/clientes');
                const container = document.getElementById('clientesList');
                
                container.innerHTML = clientes.length ? clientes.map(c => `
                    <div class="card">
                        <h3>${c.nombre} ${c.apellido}</h3>
                        <p><strong>DNI:</strong> ${c.dni}</p>
                        <p><strong>Tel:</strong> ${c.telefono || 'N/A'}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay clientes</p>';
            } catch (e) {
                document.getElementById('clientesList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarMinutas() {
            try {
                const minutas = await apiCall('/api/minutas');
                const container = document.getElementById('minutasList');
                
                container.innerHTML = minutas.length ? minutas.map(m => `
                    <div class="card">
                        <h3>Minuta #${m.id}</h3>
                        <p><strong>Veh√≠culo:</strong> ${m.marca} ${m.modelo}</p>
                        <p><strong>Cliente:</strong> ${m.cliente_nombre} ${m.cliente_apellido}</p>
                        <p><strong>Precio:</strong> $${m.precio_final?.toLocaleString() || 'N/A'}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay minutas</p>';
            } catch (e) {
                document.getElementById('minutasList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarUsuarios() {
            if (!currentUser?.es_premium) return;
            
            try {
                const usuarios = await apiCall('/api/usuarios/todos');
                const container = document.getElementById('usuariosList');
                
                container.innerHTML = usuarios.map(u => `
                    <div class="card usuario-card ${u.habilitado ? 'activo' : 'suspendido'}">
                        <h3>${u.nombre}</h3>
                        <p><strong>Email:</strong> ${u.email}</p>
                        <p><strong>Rol:</strong> ${u.rol}</p>
                        <p><strong>Estado:</strong> ${u.habilitado ? 'üü¢ Activo' : 'üî¥ Suspendido'}</p>
                        ${!u.es_premium ? `
                            ${u.habilitado ? 
                                `<button class="btn btn-danger" style="margin-top:10px" onclick="suspenderUsuario(${u.id})">Suspender</button>` :
                                `<button class="btn btn-success" style="margin-top:10px" onclick="reactivarUsuario(${u.id})">Reactivar</button>`
                            }
                        ` : ''}
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('usuariosList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarAuditoria() {
            if (!currentUser?.es_premium) return;
            
            try {
                const auditoria = await apiCall('/api/auditoria');
                const container = document.getElementById('auditoriaBody');
                
                container.innerHTML = auditoria.slice(0, 30).map(a => `
                    <tr>
                        <td style="padding:5px; font-size:0.75em">${new Date(a.fecha_dispositivo || a.fecha_accion || Date.now()).toLocaleString()}</td>
                        <td style="padding:5px">${a.usuario_nombre || 'Sistema'}</td>
                        <td style="padding:5px">${a.accion}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Sin registros</td></tr>';
            } catch (e) {
                document.getElementById('auditoriaBody').innerHTML = '<tr><td colspan="3">Error</td></tr>';
            }
        }

        async function suspenderUsuario(id) {
            const motivo = prompt('Motivo de la suspensi√≥n:');
            if (!motivo) return;
            
            try {
                await apiCall(`/api/usuarios/${id}/suspender`, 'POST', {
                    motivo,
                    mensaje: 'Cuenta suspendida',
                    duracion: 'indefinido',
                    usuario_premium_id: currentUser.id
                });
                alert('‚úÖ Usuario suspendido');
                cargarUsuarios();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function reactivarUsuario(id) {
            if (!confirm('¬øReactivar usuario?')) return;
            
            try {
                await apiCall(`/api/usuarios/${id}/reactivar`, 'POST', {
                    usuario_premium_id: currentUser.id
                });
                alert('‚úÖ Usuario reactivado');
                cargarUsuarios();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function agregarVehiculo(event) {
            event.preventDefault();
            
            try {
                await apiCall('/api/vehiculos', 'POST', {
                    tipo: document.getElementById('vehTipo').value,
                    marca: document.getElementById('vehMarca').value,
                    modelo: document.getElementById('vehModelo').value,
                    version: document.getElementById('vehVersion').value,
                    anio: document.getElementById('vehAnio').value,
                    condicion: document.getElementById('vehCondicion').value,
                    precio: document.getElementById('vehPrecio').value,
                    dominio: document.getElementById('vehDominio').value
                });
                alert('‚úÖ Veh√≠culo agregado');
                event.target.reset();
                cargarVehiculos();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function agregarCliente(event) {
            event.preventDefault();
            
            try {
                await apiCall('/api/clientes', 'POST', {
                    nombre: document.getElementById('cliNombre').value,
                    apellido: document.getElementById('cliApellido').value,
                    dni: document.getElementById('cliDni').value,
                    telefono: document.getElementById('cliTelefono').value,
                    email: document.getElementById('cliEmail').value,
                    direccion: document.getElementById('cliDireccion').value
                });
                alert('‚úÖ Cliente agregado');
                event.target.reset();
                cargarClientes();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const savedIP = localStorage.getItem('serverIP');
            if (savedIP) {
                document.getElementById('serverIP').value = savedIP;
            }
            showMainMenu(false);
        });

        // Funciones de descarga
        function descargarExcel() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo el administrador premium puede exportar');
                return;
            }
            API_URL = getServerURL();
            window.open(`${API_URL}/api/exportar-excel`, '_blank');
        }

        async function descargarJSON() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo el administrador premium puede exportar');
                return;
            }
            try {
                const datos = await apiCall('/api/exportar-datos');
                const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `concesionaria_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('‚úÖ Archivo JSON descargado. S√∫belo a Google Drive para respaldo.');
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
