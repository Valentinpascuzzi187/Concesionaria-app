<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Concesionaria Pro</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.3em;
            color: #333;
            text-align: center;
        }

        .header .user-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .nav-mobile {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 0.85em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .card h3 {
            font-size: 1em;
            color: #333;
            margin-bottom: 8px;
        }

        .card p {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .estado-disponible { color: #28a745; font-weight: bold; }
        .estado-reservado { color: #ffc107; font-weight: bold; }
        .estado-vendido { color: #dc3545; font-weight: bold; }

        .usuario-card.activo { border-left-color: #28a745; }
        .usuario-card.suspendido { border-left-color: #dc3545; }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 1.2em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .config-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #ffc107;
        }

        .config-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .config-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffc107;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display:flex; align-items:center; gap:12px; justify-content:center;">
                <img id="brandLogo" class="brand-logo" src="/assets/logo.png" alt="Logo" onerror="this.onerror=null;this.src='/assets/logo.svg'">
                <div>
                    <h1 style="margin:0; font-size:1.2em">De Gracia - Automotores</h1>
                    <div class="user-info" id="userInfo">No conectado</div>
                </div>
            </div>
        </div>

        <nav class="nav-mobile" id="mainNav" style="display: none;">
            <button class="nav-btn" onclick="showSection('dashboard')">üè† Inicio</button>
            <button class="nav-btn" onclick="showSection('vehiculos')">üöó Stock</button>
            <button class="nav-btn" onclick="showSection('clientes')">üë• Clientes</button>
            <button class="nav-btn" onclick="showSection('minutas')">üìã Minutas</button>
            <button class="nav-btn premium-only" onclick="showSection('usuarios')">üë§ Usuarios</button>
            <button class="nav-btn premium-only" onclick="showSection('auditoria')">üîç Auditor√≠a</button>
        </nav>

        <!-- Login -->
        <section id="login" class="section active">
            <h2>üîê Iniciar Sesi√≥n</h2>
            
            <div class="config-box">
                <h4>‚öôÔ∏è Configuraci√≥n del Servidor</h4>
                <input type="text" id="serverIP" placeholder="IP del servidor (ej: 192.168.1.100)" value="slinkily-numerous-reynalda.ngrok-free.dev">
                <small style="color: #856404;">Ya configurado para acceso p√∫blico. Solo haz clic en "Iniciar Sesi√≥n"</small>
            </div>

            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="loginEmail" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="Tu contrase√±a">
            </div>
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showSection('register')">Crear Cuenta</button>
        </section>

        <!-- Register -->
        <section id="register" class="section">
            <h2>üìù Crear Cuenta</h2>
            <div class="form-group">
                <label>üë§ Nombre</label>
                <input type="text" id="regNombre" placeholder="Tu nombre">
            </div>
            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="regEmail" placeholder="usuario@ejemplo.com">
            </div>
            <div class="form-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="regPassword" placeholder="Tu contrase√±a">
            </div>
            <div class="form-group">
                <label>üé≠ Rol</label>
                <select id="regRol">
                    <option value="vendedor">Vendedor</option>
                    <option value="administrador">Administrador</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="register()">Registrarse</button>
            <button class="btn btn-secondary" onclick="showSection('login')">Volver al Login</button>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="section">
            <h2>üè† Dashboard</h2>
            <div class="card">
                <h3>üëã Bienvenido</h3>
                <p>Usa el men√∫ superior para navegar por la aplicaci√≥n.</p>
            </div>
            <div class="card">
                <h3>üìä Resumen</h3>
                <p id="dashboardStats">Cargando estad√≠sticas...</p>
            </div>
        </section>

        <!-- Veh√≠culos -->
        <section id="vehiculos" class="section">
            <h2>üöó Stock de Veh√≠culos</h2>
            <div class="list-container" id="vehiculosList">
                <p class="empty-message">Cargando veh√≠culos...</p>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">‚ûï Agregar Veh√≠culo</h3>
            <form onsubmit="agregarVehiculo(event)">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="vehTipo" required>
                        <option value="auto">Auto</option>
                        <option value="camioneta">Camioneta</option>
                        <option value="moto">Moto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" id="vehMarca" required placeholder="Ej: Toyota">
                </div>
                <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" id="vehModelo" required placeholder="Ej: Corolla">
                </div>
                <div class="form-group">
                    <label>Versi√≥n</label>
                    <input type="text" id="vehVersion" placeholder="Ej: XEI">
                </div>
                <div class="form-group">
                    <label>A√±o</label>
                    <input type="number" id="vehAnio" required placeholder="2024">
                </div>
                <div class="form-group">
                    <label>Condici√≥n</label>
                    <select id="vehCondicion" required>
                        <option value="nuevo">Nuevo</option>
                        <option value="usado">Usado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Precio</label>
                    <input type="number" id="vehPrecio" required placeholder="25000000">
                </div>
                <div class="form-group">
                    <label>Dominio</label>
                    <input type="text" id="vehDominio" placeholder="ABC123">
                </div>
                <div class="form-group">
                    <label>Imagen (miniatura)</label>
                    <input type="file" id="vehImagen" accept="image/*">
                </div>
                <button type="submit" class="btn btn-success">Agregar Veh√≠culo</button>
            </form>
        </section>

        <!-- Clientes -->
        <section id="clientes" class="section">
            <h2>üë• Clientes</h2>
            <div class="list-container" id="clientesList">
                <p class="empty-message">Cargando clientes...</p>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">‚ûï Agregar Cliente</h3>
            <form onsubmit="agregarCliente(event)">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="cliNombre" required placeholder="Juan">
                </div>
                <div class="form-group">
                    <label>Apellido</label>
                    <input type="text" id="cliApellido" required placeholder="P√©rez">
                </div>
                <div class="form-group">
                    <label>DNI</label>
                    <input type="text" id="cliDni" required placeholder="12345678">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="cliTelefono" placeholder="1122334455">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="cliEmail" placeholder="cliente@email.com">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <input type="text" id="cliDireccion" placeholder="Calle 123">
                </div>
                <button type="submit" class="btn btn-success">Agregar Cliente</button>
            </form>
        </section>

        <!-- Minutas -->
        <section id="minutas" class="section">
            <h2>üìã Minutas</h2>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div></div>
                <div>
                    <button class="btn btn-primary" onclick="toggleMinutaForm()" style="margin-right:8px;">‚ûï A√±adir Minuta</button>
                </div>
            </div>

            <div id="minutaForm" style="display:none; margin-bottom:15px; background:#f1f5f9; padding:12px; border-radius:10px;">
                <div class="form-group">
                    <label>Veh√≠culo</label>
                    <select id="minVehiculo"></select>
                </div>
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="minCliente"></select>
                </div>
                <div class="form-group">
                    <label>Precio Original</label>
                    <input type="number" id="minPrecioOriginal">
                </div>
                <div class="form-group">
                    <label>Precio Final</label>
                    <input type="number" id="minPrecioFinal">
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <input type="text" id="minObservaciones">
                </div>
                <div class="form-group">
                    <label>Financiamiento</label>
                    <select id="minFinanciamiento">
                        <option value="">Ninguno</option>
                        <option value="financiera">Financiera</option>
                        <option value="concesionaria">Concesionaria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Anticipo (si aplica)</label>
                    <input type="number" id="minFinAnticipo" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Cuotas (si aplica)</label>
                    <input type="number" id="minFinCuotas" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Precio financiado (si aplica)</label>
                    <input type="number" id="minFinPrecio" placeholder="0">
                </div>
                <div class="form-group">
                    <label>¬øTrae veh√≠culo en parte de pago?</label>
                    <input type="checkbox" id="minTradein">
                </div>
                <div class="form-group">
                    <label>Datos del veh√≠culo entregado (marca, modelo, a√±o, valor)</label>
                    <input type="text" id="minTradeinDatos" placeholder="Ej: Toyota Corolla 2015 - valor 1.200.000">
                </div>
                <div class="form-group">
                    <label>Monto de reserva</label>
                    <input type="number" id="minReservaMonto" value="1000000">
                </div>
                <button class="btn btn-success" onclick="submitMinuta()">Confirmar Minuta</button>
                <button class="btn btn-secondary" onclick="toggleMinutaForm()">Cancelar</button>
            </div>

            <div class="list-container" id="minutasList">
                <p class="empty-message">Cargando minutas...</p>
            </div>
        </section>

        <!-- Usuarios (Premium) -->
        <section id="usuarios" class="section">
            <h2>üë§ Control de Usuarios</h2>
            <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center;">
                <button class="btn btn-primary" onclick="cargarAlertasRecientes()">üîî Alertas recientes</button>
                <button class="btn btn-secondary" onclick="cargarNotificaciones()">üì® Notificaciones</button>
            </div>

            <div id="alertasBox" style="display:none; margin-bottom:12px;">
                <h4>üîî Alertas Premium</h4>
                <div class="list-container" id="alertasList"></div>
            </div>

            <div id="notificacionesBox" style="display:none; margin-bottom:12px;">
                <h4>üì® Notificaciones</h4>
                <div class="list-container" id="notificacionesList"></div>
            </div>

            <div class="list-container" id="usuariosList">
                <p class="empty-message">Cargando usuarios...</p>
            </div>
        </section>

        <!-- Auditor√≠a (Premium) -->
        <section id="auditoria" class="section">
            <h2>üîç Auditor√≠a</h2>
            
            <!-- Botones de Exportaci√≥n -->
            <div style="margin-bottom: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0;">üìä Exportar Datos</h4>
                <button class="btn btn-success" onclick="descargarExcel()" style="margin-right: 10px;">
                    üì• Descargar Excel
                </button>
                <button class="btn btn-primary" onclick="descargarJSON()">
                    üìÑ Descargar JSON
                </button>
                <p style="margin: 10px 0 0 0; font-size: 0.8em; color: #666;">
                    Descarga todos los datos para subir a Google Drive
                </p>
            </div>
            
            <div class="list-container">
                <table style="width: 100%; font-size: 0.8em;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 8px;">Fecha</th>
                            <th style="padding: 8px;">Usuario</th>
                            <th style="padding: 8px;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="auditoriaBody">
                        <tr><td colspan="3" class="empty-message">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">üö™</button>
    </div>

    <script>
        // Configuraci√≥n
        let API_URL = 'http://localhost:4000';
        let currentUser = null;
        let currentSessionId = null;

        function getServerURL() {
            // Detectar autom√°ticamente si estamos en producci√≥n o local
            const currentHost = window.location.hostname;
            const currentProtocol = window.location.protocol;
            
            // Si estamos en el mismo servidor (producci√≥n), usar la misma URL
            if (currentHost !== 'localhost' && currentHost !== '127.0.0.1' && !currentHost.startsWith('192.168')) {
                return `${currentProtocol}//${currentHost}`;
            }
            
            // Si hay IP configurada manualmente
            const serverIP = document.getElementById('serverIP').value || localStorage.getItem('serverIP') || 'localhost';
            localStorage.setItem('serverIP', serverIP);
            
            if (serverIP.includes('ngrok') || serverIP.includes('railway') || serverIP.includes('render')) {
                return `https://${serverIP}`;
            }
            return `http://${serverIP}:4000`;
        }

        // Funciones de navegaci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            if (currentUser && currentSessionId) {
                trackNavegacion(sectionId);
            }

            switch(sectionId) {
                case 'vehiculos': cargarVehiculos(); break;
                case 'clientes': cargarClientes(); break;
                case 'minutas': cargarMinutas(); break;
                case 'usuarios': cargarUsuarios(); break;
                case 'auditoria': cargarAuditoria(); break;
            }
        }

        function showMainMenu(show) {
            document.getElementById('mainNav').style.display = show ? 'flex' : 'none';
            document.getElementById('logoutBtn').style.display = show ? 'block' : 'none';
            
            document.querySelectorAll('.premium-only').forEach(btn => {
                btn.style.display = (show && currentUser && currentUser.es_premium) ? 'inline-block' : 'none';
            });
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            API_URL = getServerURL();
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(`${API_URL}${endpoint}`, options);
            return response.json();
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('‚ö†Ô∏è Ingresa email y contrase√±a');
                return;
            }

            try {
                API_URL = getServerURL();
                const result = await apiCall('/api/auth/login', 'POST', { email, password });
                
                if (result.user) {
                    currentUser = result.user;
                    currentSessionId = result.user.sesion_id;
                    
                    document.getElementById('userInfo').textContent = `${currentUser.nombre} (${currentUser.rol})`;
                    showMainMenu(true);
                    showSection('dashboard');
                    
                    alert('‚úÖ Bienvenido ' + currentUser.nombre);
                } else {
                    alert('‚ùå ' + (result.message || 'Error al iniciar sesi√≥n'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n. Verifica la IP del servidor.\n\n' + error.message);
            }
        }

        async function register() {
            const nombre = document.getElementById('regNombre').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const rol = document.getElementById('regRol').value;

            if (!nombre || !email || !password) {
                alert('‚ö†Ô∏è Completa todos los campos');
                return;
            }

            try {
                API_URL = getServerURL();
                const result = await apiCall('/api/auth/register', 'POST', { nombre, email, password, rol });
                
                if (result.user) {
                    alert('‚úÖ Usuario registrado correctamente');
                    showSection('login');
                } else {
                    alert('‚ùå ' + (result.message || 'Error al registrar'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        async function logout() {
            if (currentUser && currentSessionId) {
                try {
                    await apiCall('/api/auth/logout', 'POST', { 
                        usuario_id: currentUser.id, 
                        sesion_id: currentSessionId 
                    });
                } catch (e) {}
            }
            
            currentUser = null;
            currentSessionId = null;
            showMainMenu(false);
            showSection('login');
            document.getElementById('userInfo').textContent = 'No conectado';
        }

        async function trackNavegacion(seccion) {
            try {
                await apiCall('/api/tracking/navegacion', 'POST', {
                    sesion_id: currentSessionId,
                    usuario_id: currentUser.id,
                    seccion,
                    accion: 'visita',
                    detalles: {}
                });
            } catch (e) {}
        }

        // Data loading functions
        async function cargarVehiculos() {
            try {
                const vehiculos = await apiCall('/api/vehiculos');
                const container = document.getElementById('vehiculosList');
                
                container.innerHTML = vehiculos.length ? vehiculos.map(v => `
                    <div class="card" style="display:flex; gap:12px; align-items:center;">
                        <div style="width:110px; flex: 0 0 110px;">
                            <img src="${v.imagen || '/assets/placeholder-car.png'}" alt="${v.marca} ${v.modelo}" style="width:100%; height:80px; object-fit:cover; border-radius:8px;">
                        </div>
                        <div style="flex:1;">
                            <h3>${v.marca} ${v.modelo} ${v.version || ''}</h3>
                            <p><strong>A√±o:</strong> ${v.anio}</p>
                            <p><strong>Precio:</strong> $${v.precio?.toLocaleString() || 'N/A'}</p>
                            <p><strong>Estado:</strong> <span class="estado-${v.estado}">${v.estado}</span></p>
                        </div>
                    </div>
                `).join('') : '<p class="empty-message">No hay veh√≠culos</p>';
            } catch (e) {
                document.getElementById('vehiculosList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarClientes() {
            try {
                const clientes = await apiCall('/api/clientes');
                const container = document.getElementById('clientesList');
                
                container.innerHTML = clientes.length ? clientes.map(c => `
                    <div class="card">
                        <h3>${c.nombre} ${c.apellido}</h3>
                        <p><strong>DNI:</strong> ${c.dni}</p>
                        <p><strong>Tel:</strong> ${c.telefono || 'N/A'}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay clientes</p>';
            } catch (e) {
                document.getElementById('clientesList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarMinutas() {
            try {
                const minutas = await apiCall('/api/minutas');
                const container = document.getElementById('minutasList');
                container.innerHTML = minutas.length ? minutas.map(m => `
                    <div class="card">
                        <h3>Minuta #${m.id}</h3>
                        <p><strong>Veh√≠culo:</strong> ${m.marca} ${m.modelo}</p>
                        <p><strong>Cliente:</strong> ${m.cliente_nombre} ${m.cliente_apellido}</p>
                        <p><strong>Precio:</strong> $${m.precio_final?.toLocaleString() || 'N/A'}</p>
                        <p><strong>Financiamiento:</strong> ${m.financiamiento || 'Ninguno'}</p>
                        <p><strong>Reserva:</strong> $${(m.reserva_monto || 0).toLocaleString()}</p>
                        ${m.tradein_proporciona ? `<p><strong>Trade-in:</strong> ${m.tradein_datos || '-'}</p>` : ''}
                        ${currentUser && currentUser.es_premium ? `
                            <div style="margin-top:10px;">
                                <button class="btn btn-danger" onclick="eliminarMinuta(${m.id})">üóëÔ∏è Eliminar</button>
                                <button class="btn btn-secondary" onclick="editarMinutaPrompt(${m.id})">‚úèÔ∏è Editar</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') : '<p class="empty-message">No hay minutas</p>';
            } catch (e) {
                document.getElementById('minutasList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        function editarMinutaPrompt(id) {
            const nuevoPrecio = prompt('Nuevo precio final (dejar vac√≠o para no modificar)');
            const nuevasObs = prompt('Nuevas observaciones (dejar vac√≠o para no modificar)');
            const reserva = prompt('Actualizar monto de reserva (dejar vac√≠o para no modificar)');
            const payload = { usuario_id: currentUser?.id };
            if (nuevoPrecio) payload.precio_final = Number(nuevoPrecio);
            if (nuevasObs) payload.observaciones = nuevasObs;
            if (reserva) payload.reserva_monto = Number(reserva);
            if (Object.keys(payload).length > 1) {
                apiCall(`/api/minutas/${id}`, 'PUT', payload).then(res => {
                    alert(res.message || 'Minuta actualizada');
                    cargarMinutas();
                }).catch(err => alert('Error: ' + err.message));
            }
        }

        function toggleMinutaForm() {
            const form = document.getElementById('minutaForm');
            form.style.display = (form.style.display === 'none' || !form.style.display) ? 'block' : 'none';
            if (form.style.display === 'block') loadMinutaOptions();
        }

        async function loadMinutaOptions() {
            try {
                const vehiculos = await apiCall('/api/vehiculos');
                const clientes = await apiCall('/api/clientes');

                const vehiculosDisponibles = vehiculos.filter(v => v.estado === 'disponible');

                const vehiculoSelect = document.getElementById('minVehiculo');
                const clienteSelect = document.getElementById('minCliente');

                vehiculoSelect.innerHTML = '<option value="">Seleccionar veh√≠culo...</option>' + vehiculosDisponibles.map(v => `
                    <option value="${v.id}" data-precio="${v.precio}">${v.marca} ${v.modelo} (${v.anio}) - $${v.precio?.toLocaleString()}</option>
                `).join('');

                clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' + clientes.map(c => `
                    <option value="${c.id}">${c.nombre} ${c.apellido} - DNI: ${c.dni}</option>
                `).join('');

                document.getElementById('minVehiculo').addEventListener('change', (e) => {
                    const opt = e.target.options[e.target.selectedIndex];
                    const precio = opt ? opt.getAttribute('data-precio') : '';
                    document.getElementById('minPrecioOriginal').value = precio || '';
                    document.getElementById('minPrecioFinal').value = precio || '';
                });
            } catch (err) {
                console.error('Error cargando opciones de minuta:', err);
            }
        }

        async function submitMinuta() {
            const vehiculo_id = parseInt(document.getElementById('minVehiculo').value);
            const cliente_id = parseInt(document.getElementById('minCliente').value);
            const precio_original = parseFloat(document.getElementById('minPrecioOriginal').value);
            const precio_final = parseFloat(document.getElementById('minPrecioFinal').value);
            const observaciones = document.getElementById('minObservaciones').value;
            const financiamiento = document.getElementById('minFinanciamiento').value;
            const financiamiento_anticipo = parseFloat(document.getElementById('minFinAnticipo').value) || 0;
            const financiamiento_cuotas = parseInt(document.getElementById('minFinCuotas').value) || 0;
            const financiamiento_precio = parseFloat(document.getElementById('minFinPrecio').value) || 0;
            const tradein_proporciona = document.getElementById('minTradein').checked;
            const tradein_datos = document.getElementById('minTradeinDatos').value;
            const reserva_monto = parseFloat(document.getElementById('minReservaMonto').value) || 0;

            if (!vehiculo_id || !cliente_id || !precio_original || !precio_final) {
                alert('‚ö†Ô∏è Completa todos los campos');
                return;
            }

            try {
                const payload = { vehiculo_id, cliente_id, vendedor_id: currentUser?.id || null, precio_original, precio_final, observaciones,
                    financiamiento, financiamiento_anticipo, financiamiento_cuotas, financiamiento_precio,
                    tradein_proporciona, tradein_datos, reserva_monto };

                const result = await apiCall('/api/minutas', 'POST', payload);
                if (result && result.minuta) {
                    alert('‚úÖ Minuta creada');
                    toggleMinutaForm();
                    cargarMinutas();
                } else {
                    alert('‚ùå ' + (result.message || 'Error al crear minuta'));
                }
            } catch (err) {
                alert('‚ùå Error al crear minuta: ' + err.message);
            }
        }

        async function cargarUsuarios() {
            if (!currentUser?.es_premium) return;
            
            try {
                const usuarios = await apiCall('/api/usuarios/todos');
                const container = document.getElementById('usuariosList');
                
                container.innerHTML = usuarios.map(u => `
                    <div class="card usuario-card ${u.habilitado ? 'activo' : 'suspendido'}">
                        <h3>${u.nombre}</h3>
                        <p><strong>Email:</strong> ${u.email}</p>
                        <p><strong>Rol:</strong> ${u.rol}</p>
                        <p><strong>Estado:</strong> ${u.habilitado ? 'üü¢ Activo' : 'üî¥ Suspendido'}</p>
                        ${!u.es_premium ? `
                            ${u.habilitado ? 
                                `<button class="btn btn-danger" style="margin-top:10px" onclick="suspenderUsuario(${u.id})">Suspender</button>` :
                                `<button class="btn btn-success" style="margin-top:10px" onclick="reactivarUsuario(${u.id})">Reactivar</button>`
                            }
                        ` : ''}
                        <div style="margin-top:10px; display:flex; gap:8px;">
                            <button class="btn btn-secondary" onclick="verSesiones(${u.id})">üïí Ver Sesiones</button>
                            <button class="btn btn-secondary" onclick="verNavegacion(${u.id})">üìç Ver Navegaci√≥n</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('usuariosList').innerHTML = '<p class="empty-message">Error al cargar</p>';
            }
        }

        async function cargarAuditoria() {
            if (!currentUser?.es_premium) return;
            
            try {
                const auditoria = await apiCall('/api/auditoria');
                const container = document.getElementById('auditoriaBody');
                
                container.innerHTML = auditoria.slice(0, 30).map(a => `
                    <tr>
                        <td style="padding:5px; font-size:0.75em">${new Date(a.fecha_dispositivo || a.fecha_accion || Date.now()).toLocaleString()}</td>
                        <td style="padding:5px">${a.usuario_nombre || 'Sistema'}</td>
                        <td style="padding:5px">${a.accion}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Sin registros</td></tr>';
            } catch (e) {
                document.getElementById('auditoriaBody').innerHTML = '<tr><td colspan="3">Error</td></tr>';
            }
        }

        // Nuevas funciones: alertas y control de usuario
        async function cargarAlertasRecientes() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo administradores premium pueden ver alertas');
                return;
            }
            try {
                const alertas = await apiCall('/api/alertas-premium');
                document.getElementById('alertasBox').style.display = 'block';
                const container = document.getElementById('alertasList');
                container.innerHTML = alertas.length ? alertas.map(a => `
                    <div class="card">
                        <h3>${a.titulo}</h3>
                        <p>${a.mensaje}</p>
                        <p style="font-size:0.8em; color:#666">${new Date(a.fecha_alerta).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay alertas</p>';
            } catch (e) {
                alert('‚ùå Error al cargar alertas: ' + e.message);
            }
        }

        async function cargarNotificaciones() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo administradores premium pueden ver notificaciones');
                return;
            }
            try {
                const nots = await apiCall('/api/notificaciones');
                document.getElementById('notificacionesBox').style.display = 'block';
                const container = document.getElementById('notificacionesList');
                container.innerHTML = nots.length ? nots.map(n => `
                    <div class="card">
                        <h3>${n.titulo}</h3>
                        <p>${n.mensaje}</p>
                        <p style="font-size:0.8em; color:#666">${new Date(n.created_at).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay notificaciones</p>';
            } catch (e) {
                alert('‚ùå Error al cargar notificaciones: ' + e.message);
            }
        }

        async function verSesiones(usuarioId) {
            try {
                const sesiones = await apiCall(`/api/tracking/sesiones/${usuarioId}`);
                const html = sesiones.length ? sesiones.map(s => `
                    <div class="card">
                        <h3>Sesi√≥n #${s.id}</h3>
                        <p><strong>Login:</strong> ${new Date(s.fecha_login).toLocaleString()}</p>
                        <p><strong>Logout:</strong> ${s.fecha_logout ? new Date(s.fecha_logout).toLocaleString() : 'Activa'}</p>
                        <p><strong>IP:</strong> ${s.ip_address || 'N/A'}</p>
                        <p><strong>Duraci√≥n (s):</strong> ${s.duracion_segundos || '-'}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay sesiones</p>';

                // Mostrar en un modal ligero (reutilizamos alertasBox)
                document.getElementById('alertasBox').style.display = 'block';
                document.getElementById('alertasList').innerHTML = `<h4>üïí Sesiones del usuario ${usuarioId}</h4>` + html;
            } catch (e) {
                alert('‚ùå Error al obtener sesiones: ' + e.message);
            }
        }

        async function verNavegacion(usuarioId) {
            try {
                const nav = await apiCall(`/api/tracking/navegacion/${usuarioId}`);
                const html = nav.length ? nav.map(n => `
                    <div class="card">
                        <h3>${n.seccion_visitada}</h3>
                        <p><strong>Acci√≥n:</strong> ${n.accion}</p>
                        <p><strong>Detalles:</strong> ${n.detalles || '-'}</p>
                        <p style="font-size:0.8em; color:#666">${new Date(n.fecha_visita).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No hay navegaci√≥n registrada</p>';

                document.getElementById('alertasBox').style.display = 'block';
                document.getElementById('alertasList').innerHTML = `<h4>üìç Navegaci√≥n del usuario ${usuarioId}</h4>` + html;
            } catch (e) {
                alert('‚ùå Error al obtener navegaci√≥n: ' + e.message);
            }
        }

        async function suspenderUsuario(id) {
            const motivo = prompt('Motivo de la suspensi√≥n:');
            if (!motivo) return;
            
            try {
                await apiCall(`/api/usuarios/${id}/suspender`, 'POST', {
                    motivo,
                    mensaje: 'Cuenta suspendida',
                    duracion: 'indefinido',
                    usuario_premium_id: currentUser.id
                });
                alert('‚úÖ Usuario suspendido');
                cargarUsuarios();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function reactivarUsuario(id) {
            if (!confirm('¬øReactivar usuario?')) return;
            
            try {
                await apiCall(`/api/usuarios/${id}/reactivar`, 'POST', {
                    usuario_premium_id: currentUser.id
                });
                alert('‚úÖ Usuario reactivado');
                cargarUsuarios();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function agregarVehiculo(event) {
            event.preventDefault();
            
            try {
                const payload = {
                    tipo: document.getElementById('vehTipo').value,
                    marca: document.getElementById('vehMarca').value,
                    modelo: document.getElementById('vehModelo').value,
                    version: document.getElementById('vehVersion').value,
                    anio: document.getElementById('vehAnio').value,
                    condicion: document.getElementById('vehCondicion').value,
                    precio: document.getElementById('vehPrecio').value,
                    dominio: document.getElementById('vehDominio').value
                };

                const fileInput = document.getElementById('vehImagen');
                if (fileInput && fileInput.files && fileInput.files.length) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    const base64 = await new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    payload.imagen_base64 = base64;
                }

                const result = await apiCall('/api/vehiculos', 'POST', payload);
                if (result && result.vehiculo) {
                    alert('‚úÖ Veh√≠culo agregado');
                    event.target.reset();
                    cargarVehiculos();
                } else {
                    alert('‚ùå ' + (result.message || 'Error al agregar veh√≠culo'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + (e.message || e));
            }
        }

        async function agregarCliente(event) {
            event.preventDefault();
            
            try {
                await apiCall('/api/clientes', 'POST', {
                    nombre: document.getElementById('cliNombre').value,
                    apellido: document.getElementById('cliApellido').value,
                    dni: document.getElementById('cliDni').value,
                    telefono: document.getElementById('cliTelefono').value,
                    email: document.getElementById('cliEmail').value,
                    direccion: document.getElementById('cliDireccion').value
                });
                alert('‚úÖ Cliente agregado');
                event.target.reset();
                cargarClientes();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const savedIP = localStorage.getItem('serverIP');
            if (savedIP) {
                document.getElementById('serverIP').value = savedIP;
            }
            showMainMenu(false);
        });

        // Funciones de descarga
        function descargarExcel() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo el administrador premium puede exportar');
                return;
            }
            API_URL = getServerURL();
            window.open(`${API_URL}/api/exportar-excel`, '_blank');
        }

        async function descargarJSON() {
            if (!currentUser?.es_premium) {
                alert('‚ö†Ô∏è Solo el administrador premium puede exportar');
                return;
            }
            try {
                const datos = await apiCall('/api/exportar-datos');
                const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `concesionaria_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('‚úÖ Archivo JSON descargado. S√∫belo a Google Drive para respaldo.');
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
