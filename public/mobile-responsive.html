<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#4a90e2">
  <title>De Grazia - Automotores</title>
  <link rel="manifest" href="manifest.json">
  
  <style>
    :root {
      --color-primary: #4a90e2;
      --color-secondary: #d4af37;
      --color-base: #1a1a1a;
      --color-dark: #2d2d2d;
      --color-light: #f5f5f5;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'Trebuchet MS', 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans', sans-serif;
      background: linear-gradient(135deg, var(--color-base) 0%, var(--color-dark) 100%);
      min-height: 100vh;
      padding: 0;
      padding-top: max(10px, env(safe-area-inset-top));
      padding-bottom: 80px;
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    /* Navbar MÃ³vil */
    .navbar-mobile {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 3px solid var(--color-secondary);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0;
      padding-bottom: env(safe-area-inset-bottom);
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .nav-btn-mobile {
      flex: 1;
      padding: 12px 0;
      background: none;
      border: none;
      color: #999;
      font-size: 0.8em;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      text-align: center;
    }

    .nav-btn-mobile.active {
      color: var(--color-primary);
      font-weight: bold;
    }

    .nav-btn-mobile:active {
      background: rgba(102, 126, 234, 0.1);
    }

    /* Header */
    .header {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .header-title h1 {
      font-size: 1.1em;
      color: #333;
      margin: 0;
    }

    .header-title p {
      font-size: 0.85em;
      color: #666;
      margin: 0;
    }

    .version-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--color-primary);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7em;
      font-weight: bold;
    }

    /* Secciones */
    .section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Tarjetas */
    .card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 15px;
    }

    .card h3 {
      font-size: 1em;
      color: var(--color-primary);
      margin-bottom: 12px;
      font-weight: bold;
    }

    /* Grid Responsivo */
    .vehiculos-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    @media (min-width: 600px) {
      .vehiculos-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .vehiculo-thumbnail {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .carrusel-container {
      position: relative;
      width: 100%;
      height: 150px;
      background: #f0f0f0;
      overflow: hidden;
    }

    .carrusel-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.3s ease;
    }

    .carrusel-dots {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.7);
      transition: background 0.3s ease;
    }

    .dot.active {
      background: white;
    }

    .progreso-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: bold;
    }

    .vehiculo-info {
      padding: 12px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .vehiculo-info h3 {
      font-size: 0.95em;
      color: #333;
      margin: 0 0 4px 0;
      font-weight: bold;
    }

    .version {
      color: #666;
      font-size: 0.8em;
      margin-bottom: 8px;
    }

    .precio {
      color: #28a745;
      font-size: 1em;
      font-weight: bold;
      margin: 8px 0;
    }

    .estado-badge {
      text-align: center;
      padding: 6px;
      border-radius: 6px;
      font-size: 0.75em;
      font-weight: bold;
      margin-top: auto;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      font-size: 0.85em;
      color: #666;
      margin: 0 0 8px 0;
      font-weight: normal;
    }

    .stat-number {
      font-size: 1.5em;
      color: var(--color-primary);
      font-weight: bold;
      margin: 0;
    }

    /* Tabla responsiva */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }

    table tr {
      border-bottom: 1px solid #eee;
    }

    table td {
      padding: 10px 8px;
    }

    table tr:first-child {
      background: #f8f9fa;
      font-weight: bold;
      font-size: 0.85em;
    }

    /* Botones */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:active {
      opacity: 0.9;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 0.8em;
    }

    /* Formularios */
    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      color: #333;
      font-weight: 500;
      font-size: 0.9em;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      font-family: inherit;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.9em;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Estado Badges */
    .estado-disponible { background: #d4edda; color: #155724; }
    .estado-proceso_venta { background: #cfe2ff; color: #004085; }
    .estado-pos_venta { background: #fff3cd; color: #856404; }
    .estado-vendido { background: #f8d7da; color: #721c24; }
    .estado-estancado { background: #f8d7da; color: #721c24; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      padding: 10px;
      padding-top: env(safe-area-inset-top);
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 100%;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* NotificaciÃ³n de actualizaciÃ³n */
    .update-notification {
      position: fixed;
      top: max(20px, env(safe-area-inset-top));
      right: max(20px, env(safe-area-inset-right));
      background: var(--color-primary);
      color: white;
      padding: 12px 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      max-width: calc(100% - 40px);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .update-notification button {
      background: white;
      color: var(--color-primary);
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      font-weight: bold;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <img src="/assets/logo.png" alt="De Grazia" class="header-logo" onerror="this.src='/assets/placeholder.svg'">
        <div class="header-title">
          <h1>De Grazia</h1>
          <p>Automotores</p>
        </div>
      </div>
      <div class="version-badge" id="versionBadge">v2.8.0</div>
    </div>

    <!-- Secciones -->
    
    <!-- Login -->
    <section id="login" class="section active card">
      <h2>Iniciar SesiÃ³n</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Email:</label>
          <input type="email" id="loginEmail" placeholder="tu@email.com" required>
        </div>
        <div class="form-group">
          <label>ContraseÃ±a:</label>
          <input type="password" id="loginPassword" placeholder="ContraseÃ±a" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar SesiÃ³n</button>
        <div id="loginMessage" class="message" style="display: none; margin-top: 10px;"></div>
      </form>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="section">
      <div class="card">
        <h2>ðŸ“Š Dashboard</h2>
        <div class="dashboard-grid">
          <div class="stat-card">
            <h3>Stock</h3>
            <p class="stat-number" id="stockCount">0</p>
          </div>
          <div class="stat-card">
            <h3>Clientes</h3>
            <p class="stat-number" id="clientesCount">0</p>
          </div>
          <div class="stat-card">
            <h3>Minutas</h3>
            <p class="stat-number" id="minutasCount">0</p>
          </div>
          <div class="stat-card">
            <h3>Ventas</h3>
            <p class="stat-number" id="ventasCount">0</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Stock -->
    <section id="stock" class="section">
      <div class="card">
        <h2>ðŸš— Stock de VehÃ­culos</h2>
        <div id="vehiculosContent"></div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="clientes" class="section">
      <div class="card">
        <h2>ðŸ‘¥ Clientes</h2>
        <div id="clientesContent"></div>
      </div>
    </section>

    <!-- Minutas -->
    <section id="minutas" class="section">
      <div class="card">
        <h2>ðŸ“‹ Minutas</h2>
        <div id="minutasContent"></div>
      </div>
    </section>

    <!-- Pagos -->
    <section id="pagos" class="section">
      <div class="card">
        <h2>ðŸ’° Pagos</h2>
        <div class="dashboard-grid">
          <div class="stat-card">
            <h3>Ingresado</h3>
            <p class="stat-number" id="totalPagado">$0</p>
          </div>
          <div class="stat-card">
            <h3>Pendiente</h3>
            <p class="stat-number" id="totalPendiente">$0</p>
          </div>
        </div>
        <div id="registroPagosContent"></div>
      </div>
    </section>

    <!-- Reportes -->
    <section id="reportes" class="section">
      <div class="card">
        <h2>ðŸ“ˆ Reportes</h2>
        <div class="dashboard-grid">
          <div class="stat-card">
            <h3>Ventas</h3>
            <p class="stat-number" id="totalVentas">0</p>
          </div>
          <div class="stat-card">
            <h3>Ingresos</h3>
            <p class="stat-number" id="ingresosTotales">$0</p>
          </div>
          <div class="stat-card">
            <h3>Stock</h3>
            <p class="stat-number" id="vehiculosStock">0</p>
          </div>
          <div class="stat-card">
            <h3>ConversiÃ³n</h3>
            <p class="stat-number" id="tasaConversion">0%</p>
          </div>
        </div>
        <div id="historialVentasContent"></div>
      </div>
    </section>
  </div>

  <!-- Navbar MÃ³vil -->
  <nav class="navbar-mobile">
    <button class="nav-btn-mobile active" onclick="showSectionMobile('dashboard')">ðŸ“Š Dashboard</button>
    <button class="nav-btn-mobile" onclick="showSectionMobile('stock')">ðŸš— Stock</button>
    <button class="nav-btn-mobile" onclick="showSectionMobile('pagos')">ðŸ’° Pagos</button>
    <button class="nav-btn-mobile" onclick="showSectionMobile('reportes')">ðŸ“ˆ Reportes</button>
    <button class="nav-btn-mobile" onclick="logout()">ðŸšª Salir</button>
  </nav>

  <!-- NotificaciÃ³n de actualizaciÃ³n -->
  <div id="updateNotification" class="update-notification" style="display: none;">
    <span>Nueva versiÃ³n disponible</span>
    <button onclick="location.reload()">Actualizar</button>
  </div>

  <script>
    let currentUser = null;
    const RAILWAY_URL = 'https://concesionaria-app-production.up.railway.app';
    let BASE = RAILWAY_URL;

    // Detectar entorno
    (() => {
      const isCapacitor = location.protocol === 'file:' || (typeof Capacitor !== 'undefined');
      if (!isCapacitor && location.host && location.host !== 'localhost') {
        BASE = `${location.protocol}//${location.host}`;
      }
    })();

    // API Client
    const call = async (endpoint, method = 'GET', body = null) => {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const resp = await fetch(`${BASE}${endpoint}`, opts);
      if (!resp.ok) throw await resp.json().catch(() => ({ message: 'Error del servidor' }));
      return resp.json();
    };

    window.api = {
      login: (email, password) => call('/api/auth/login', 'POST', { email, password }),
      logout: () => call('/api/auth/logout', 'POST', {}),
      getVehiculos: () => call('/api/vehiculos'),
      getClientes: () => call('/api/clientes'),
      getMinutas: () => call('/api/minutas'),
      getVersion: () => call('/api/version'),
      // MÃ©todos para almacenamiento de archivos
      subirFotoBlob: (vehiculoId, archivo, tipoMime, nombre, tipo) => 
        call(`/api/vehiculos/${vehiculoId}/fotos/upload-blob`, 'POST', { archivo, tipo_mime: tipoMime, nombre, tipo }),
      descargarFoto: (fotoId) => `${BASE}/api/fotos/${fotoId}/descargar`,
      subirDocumentoCliente: (clienteId, archivo, tipoMime, nombre, tipo, notas) =>
        call(`/api/clientes/${clienteId}/documentos/upload`, 'POST', { archivo, tipo_mime: tipoMime, nombre, tipo, notas }),
      obtenerDocumentosCliente: (clienteId) => call(`/api/clientes/${clienteId}/documentos`),
      descargarDocumentoCliente: (clienteId, docId) => `${BASE}/api/clientes/${clienteId}/documentos/${docId}/descargar`,
      eliminarDocumentoCliente: (clienteId, docId) => call(`/api/clientes/${clienteId}/documentos/${docId}`, 'DELETE'),
      subirArchivoMinuta: (minutaId, archivo, tipoMime, nombre, tipo, descripcion) =>
        call(`/api/minutas/${minutaId}/archivos/upload`, 'POST', { archivo, tipo_mime: tipoMime, nombre, tipo, descripcion }),
      obtenerArchivosMinuta: (minutaId) => call(`/api/minutas/${minutaId}/archivos`),
      descargarArchivoMinuta: (minutaId, archivoId) => `${BASE}/api/minutas/${minutaId}/archivos/${archivoId}/descargar`,
      eliminarArchivoMinuta: (minutaId, archivoId) => call(`/api/minutas/${minutaId}/archivos/${archivoId}`, 'DELETE'),
      getFotosVehiculo: (vehiculoId) => call(`/api/vehiculos/${vehiculoId}/fotos`)
    };

    // Login
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const msg = document.getElementById('loginMessage');

      try {
        const result = await window.api.login(email, password);
        currentUser = result.user;
        msg.textContent = 'âœ… Bienvenido';
        msg.className = 'message success';
        msg.style.display = 'block';
        setTimeout(() => showSectionMobile('dashboard'), 1000);
      } catch (error) {
        msg.textContent = 'âŒ ' + (error.message || 'Error');
        msg.className = 'message error';
        msg.style.display = 'block';
      }
    });

    // Mostrar secciones
    function showSectionMobile(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId)?.classList.add('active');

      document.querySelectorAll('.nav-btn-mobile').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      if (sectionId === 'dashboard') loadDashboard();
      else if (sectionId === 'stock') loadVehiculos();
      else if (sectionId === 'clientes') loadClientes();
      else if (sectionId === 'minutas') loadMinutas();
      else if (sectionId === 'pagos') loadPagos();
      else if (sectionId === 'reportes') loadReportes();
    }

    // Cargar Dashboard
    async function loadDashboard() {
      try {
        const [vehiculos, clientes, minutas] = await Promise.all([
          window.api.getVehiculos(),
          window.api.getClientes(),
          window.api.getMinutas()
        ]);
        document.getElementById('stockCount').textContent = vehiculos.length;
        document.getElementById('clientesCount').textContent = clientes.length;
        document.getElementById('minutasCount').textContent = minutas.filter(m => m.estado !== 'cerrada').length;
        document.getElementById('ventasCount').textContent = minutas.filter(m => m.estado === 'cerrada').length;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Cargar VehÃ­culos
    async function loadVehiculos() {
      try {
        const vehiculos = await window.api.getVehiculos();
        const contenedor = document.getElementById('vehiculosContent');

        if (!vehiculos || vehiculos.length === 0) {
          contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay vehÃ­culos</p>';
          return;
        }

        let html = '<div class="vehiculos-grid">';
        for (const v of vehiculos) {
          let fotos = [];
          try {
            fotos = await window.api.getFotosVehiculo?.(v.id) || [];
          } catch (e) {}

          const fotosArray = fotos.length > 0 ? fotos : [{url_imagen: '/assets/placeholder.svg'}];
          html += `
            <div class="vehiculo-thumbnail">
              <div class="carrusel-container" data-vehiculo-id="${v.id}">
                <img class="carrusel-image" src="${fotosArray[0].url_imagen}" alt="${v.marca}">
                <div class="carrusel-dots">
                  ${fotosArray.map((_, i) => `<span class="dot ${i === 0 ? 'active' : ''}"></span>`).join('')}
                </div>
              </div>
              <div class="vehiculo-info">
                <h3>${v.marca} ${v.modelo}</h3>
                <p class="version">${v.version || 'S/V'} - ${v.anio}</p>
                <p class="precio">$${(v.precio || 0).toLocaleString('es-AR')}</p>
                <div class="estado-badge estado-${v.estado}">
                  ${v.estado.replace(/_/g, ' ').toUpperCase()}
                </div>
              </div>
            </div>
          `;
          setTimeout(() => iniciarCarruselMovil(v.id, fotosArray), 100);
        }
        html += '</div>';
        contenedor.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Carrusel mÃ³vil
    function iniciarCarruselMovil(vehiculoId, fotos) {
      if (!fotos || fotos.length <= 1) return;
      let idx = 0;
      const container = document.querySelector(`[data-vehiculo-id="${vehiculoId}"]`);
      if (!container) return;

      const img = container.querySelector('.carrusel-image');
      const dots = container.querySelectorAll('.dot');

      setInterval(() => {
        idx = (idx + 1) % fotos.length;
        img.style.opacity = '0.5';
        setTimeout(() => {
          img.src = fotos[idx].url_imagen;
          img.style.opacity = '1';
        }, 150);
        dots.forEach((dot, i) => dot.classList.toggle('active', i === idx));
      }, 3000);
    }

    // Cargar Clientes
    async function loadClientes() {
      try {
        const clientes = await window.api.getClientes();
        const contenedor = document.getElementById('clientesContent');
        if (!clientes || clientes.length === 0) {
          contenedor.innerHTML = '<p style="text-align: center;">Sin clientes registrados</p>';
          return;
        }
        let html = `<table><tr><td>Nombre</td><td>Email</td></tr>`;
        clientes.forEach(c => {
          html += `<tr><td>${c.nombre} ${c.apellido}</td><td>${c.email || 'N/A'}</td></tr>`;
        });
        html += '</table>';
        contenedor.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Cargar Minutas
    async function loadMinutas() {
      try {
        const minutas = await window.api.getMinutas();
        const contenedor = document.getElementById('minutasContent');
        if (!minutas || minutas.length === 0) {
          contenedor.innerHTML = '<p style="text-align: center;">Sin minutas</p>';
          return;
        }
        let html = `<table><tr><td>NÂº</td><td>Estado</td><td>Monto</td></tr>`;
        minutas.forEach(m => {
          html += `<tr><td>${m.id}</td><td>${m.estado}</td><td>$${(m.precio_final || 0).toLocaleString('es-AR')}</td></tr>`;
        });
        html += '</table>';
        contenedor.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Cargar Pagos
    async function loadPagos() {
      try {
        const minutas = await window.api.getMinutas();
        let pagado = 0, pendiente = 0;
        minutas.forEach(m => {
          const monto = parseFloat(m.precio_final) || 0;
          if (m.pagado) pagado += monto;
          else pendiente += monto;
        });
        document.getElementById('totalPagado').textContent = '$' + pagado.toLocaleString('es-AR');
        document.getElementById('totalPendiente').textContent = '$' + pendiente.toLocaleString('es-AR');
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Cargar Reportes
    async function loadReportes() {
      try {
        const [vehiculos, minutas] = await Promise.all([window.api.getVehiculos(), window.api.getMinutas()]);
        const ventas = minutas.filter(m => m.estado === 'cerrada').length;
        let ingresos = 0;
        minutas.forEach(m => {
          if (m.pagado) ingresos += parseFloat(m.precio_final) || 0;
        });
        const stock = vehiculos.filter(v => v.estado === 'disponible').length;
        const conversion = vehiculos.length > 0 ? ((ventas / vehiculos.length) * 100).toFixed(1) : '0';

        document.getElementById('totalVentas').textContent = ventas;
        document.getElementById('ingresosTotales').textContent = '$' + ingresos.toLocaleString('es-AR');
        document.getElementById('vehiculosStock').textContent = stock;
        document.getElementById('tasaConversion').textContent = conversion + '%';
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Logout
    function logout() {
      currentUser = null;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('login').classList.add('active');
    }

    // Chequear actualizaciones
    async function checkUpdates() {
      try {
        const result = await window.api.getVersion();
        const currentVersion = document.getElementById('versionBadge').textContent.trim();
        if (result.version !== currentVersion) {
          document.getElementById('updateNotification').style.display = 'flex';
        }
      } catch (error) {
        console.log('No se pudo chequear actualizaciones');
      }
    }

    // Chequear actualizaciones cada 5 minutos
    setInterval(checkUpdates, 300000);
    checkUpdates();
  </script>
</body>
</html>
