# De Grazia Automotores - v2.9.0 Release Notes

## üéØ Resumen de Cambios
v2.9.0 introduce soporte m√≥vil completo, almacenamiento persistente de archivos en MySQL, y sistema de notificaci√≥n de actualizaciones.

## ‚ú® Nuevas Caracter√≠sticas

### 1. üì± Mobile Responsive (Pantalla Vertical Optimizada)
- **Nuevo archivo**: `public/mobile-responsive.html`
- Navegaci√≥n inferior con 5 botones para acceso r√°pido
- Dise√±o single-column en m√≥vil (1 columna)
- Viewport meta tags optimizados para iOS/Android
- Safe area insets para dispositivos con notch
- Carrusel de veh√≠culos compatible con m√≥vil (3 segundos auto-rotate)
- Tablas responsivas con scroll horizontal
- Botones con tap targets de 44px m√≠nimo (Apple HIG)
- Font size: 16px base para mejor legibilidad en m√≥vil

### 2. üíæ Almacenamiento MySQL de Archivos
New database tables:
- `fotografia_vehiculo` - Campos mejorados:
  - `archivo LONGBLOB` - Imagen binaria almacenada
  - `tipo_mime VARCHAR(50)` - MIME type para descarga correcta
  - `size INT` - Tama√±o en bytes

- `documentos_cliente` - Nueva tabla:
  - Almacena DNIs, licencias, comprobantes de domicilio
  - Vinculado a `clientes(id)`
  - `archivo LONGBLOB`, `tipo_mime`, `size`

- `archivos_minuta` - Nueva tabla:
  - Almacena PDFs de minutas, contratos, documentaci√≥n
  - Vinculado a `minutas(id)`
  - Sistema de tipos (factura, contrato, etc.)

- `archivos_generales` - Nueva tabla:
  - Almacenamiento gen√©rico para futuras extensiones
  - Referencia flexible a cualquier tabla

### 3. üîî Notificaci√≥n de Actualizaciones
- New endpoint: `GET /api/version`
  - Retorna `{version, timestamp, updateAvailable}`
- Sistema de polling cada 5 minutos
- Notificaci√≥n visual en pantalla
- Bot√≥n de actualizaci√≥n fuerza reload de p√°gina
- Compatible con PWA para actualizaci√≥n de contenido

### 4. üÜï Nuevos Endpoints API (v2.9.0)

#### Fotos de Veh√≠culos
```
POST   /api/vehiculos/{id}/fotos/upload-blob        - Subir foto con archivo binario
GET    /api/fotos/{id}/descargar                    - Descargar foto (streaming binario)
```

#### Documentos de Cliente
```
POST   /api/clientes/{id}/documentos/upload         - Subir documento (DNI, etc.)
GET    /api/clientes/{id}/documentos                - Listar documentos
GET    /api/clientes/{id}/documentos/{docId}/descargar
DELETE /api/clientes/{id}/documentos/{docId}        - Eliminar documento
```

#### Archivos de Minuta
```
POST   /api/minutas/{id}/archivos/upload            - Subir archivo/PDF
GET    /api/minutas/{id}/archivos                   - Listar archivos
GET    /api/minutas/{id}/archivos/{archivoId}/descargar
DELETE /api/minutas/{id}/archivos/{archivoId}       - Eliminar archivo
```

## üìä Cambios de Base de Datos

### Tablas Modificadas
```sql
ALTER TABLE fotografia_vehiculo 
  ADD COLUMN archivo LONGBLOB NULL,
  ADD COLUMN tipo_mime VARCHAR(50) DEFAULT 'image/jpeg',
  ADD COLUMN size INT DEFAULT 0;
```

### Tablas Nuevas
```sql
CREATE TABLE documentos_cliente (
  id INT PRIMARY KEY AUTO_INCREMENT,
  cliente_id INT NOT NULL,
  tipo VARCHAR(100) NOT NULL,
  nombre VARCHAR(255) NOT NULL,
  archivo LONGBLOB NOT NULL,
  tipo_mime VARCHAR(50) NOT NULL,
  size INT NOT NULL,
  notas TEXT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (cliente_id) REFERENCES clientes(id) ON DELETE CASCADE
);

CREATE TABLE archivos_minuta (
  id INT PRIMARY KEY AUTO_INCREMENT,
  minuta_id INT NOT NULL,
  tipo VARCHAR(100) NOT NULL,
  nombre VARCHAR(255) NOT NULL,
  archivo LONGBLOB NOT NULL,
  tipo_mime VARCHAR(50) NOT NULL,
  size INT NOT NULL,
  descripcion TEXT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (minuta_id) REFERENCES minutas(id) ON DELETE CASCADE
);

CREATE TABLE archivos_generales (
  id INT PRIMARY KEY AUTO_INCREMENT,
  referencia_tabla VARCHAR(100) NOT NULL,
  referencia_id INT NOT NULL,
  tipo_archivo VARCHAR(100) NOT NULL,
  nombre VARCHAR(255) NOT NULL,
  archivo LONGBLOB NOT NULL,
  tipo_mime VARCHAR(50) NOT NULL,
  size INT NOT NULL,
  descripcion TEXT NULL,
  created_by INT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (created_by) REFERENCES usuarios(id) ON DELETE SET NULL
);
```

## üîß Cambios de C√≥digo

### server.js
- Actualizado APP_VERSION a "2.9.0"
- Nuevos endpoints de archivo storage
- Sistema de descarga de BLOB con headers correctos
- Validaci√≥n de cliente/minuta existente para operaciones de archivos

### public/mobile-responsive.html (NUEVO)
- 870 l√≠neas de c√≥digo HTML+CSS+JS
- Navegaci√≥n m√≥vil optimizada
- Carrusel responsive compatible con peque√±as pantallas
- Secciones: Dashboard, Stock, Pagos, Reportes, Logout
- Sistema de notificaci√≥n de updates

### public/index.html (NO CAMBIOS)
- Compatible con v2.9.0
- Mantiene versi√≥n v2.8.0

## üöÄ Deployment

### Railway Auto-Deploy
Los cambios se sincronizar√°n autom√°ticamente:
1. Git push a `main` branch
2. Railway detecta cambios
3. API se redeploy con nuevos endpoints
4. Base de datos MySQL actualiza autom√°ticamente via `initTables()` y `ensureColumns()`

### Capacitor APK
Compilar nueva versi√≥n:
```bash
cd android && ./gradlew clean assembleDebug
```
Salida: `app-debug-v2.9.0.apk` (approx. 4.2 MB)

## üìã Testing Checklist

- [ ] Login funciona en web y m√≥vil
- [ ] Carrusel de veh√≠culos rota cada 3 segundos
- [ ] Subir foto a veh√≠culo guarda en MySQL
- [ ] Descargar foto recupera BLOB correctamente
- [ ] Subir documento a cliente funciona
- [ ] Listar documentos muestra todos en orden DESC
- [ ] Notificaci√≥n de versi√≥n aparece cada 5 min
- [ ] Bot√≥n "Actualizar" recarga p√°gina correctamente
- [ ] M√≥vil: Los 5 botones de navegaci√≥n funcionan
- [ ] M√≥vil: Carrusel es visible en pantalla vertical
- [ ] M√≥vil: Tablas son responsivas

## ‚ö†Ô∏è Breaking Changes
Ninguno. v2.9.0 es totalmente backward compatible con v2.8.0.

## üîê Seguridad
- Validaci√≥n de cliente_id / vehiculo_id / minuta_id en todos los endpoints
- BLOB almacenado en MySQL (no en filesystem)
- Headers Content-Type y Content-Disposition correctos para descarga
- Sin exposici√≥n de rutas de archivo local

## üì¶ Tama√±o de Descarga
- APK: 4.2 MB (sin cambios respecto a v2.8.0)
- Archivo promedio en MySQL: 1-5 MB dependiendo del tipo

## üéì Notas para Desarrolladores
- `getFotosVehiculo()` puede traer muchas fotos - considerar paginaci√≥n en v3.0
- BLOB en MySQL funciona bien hasta 16 MB (max_allowed_packet)
- Para im√°genes muy grandes, usar compresi√≥n antes de upload
- Sistema de polling de versi√≥n es simple - considerar WebSocket en v3.0

## üìû Soporte
- Para issues con storage: revisar size del BLOB y max_allowed_packet de MySQL
- Para issues con m√≥vil: revisar viewport meta tags
- Contactar: support@degraziaautomotores.com

---
**Versi√≥n**: 2.9.0  
**Fecha**: 2026-01-16  
**Desarrollador**: GitHub Copilot  
**Status**: ‚úÖ LISTO PARA PRODUCCI√ìN
